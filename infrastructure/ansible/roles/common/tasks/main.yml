---
- name: Ensure base packages are present
  ansible.builtin.package:
    name:
      - git
      - curl
      - python3-pip
      - docker.io
    state: present

- name: Add deployment users
  ansible.builtin.user:
    name: "{{ item.name }}"
    shell: /bin/bash
    groups: "{{ item.groups | join(',') }}"
    state: present
  loop: "{{ users | default([]) }}"

- name: Enable and start Docker
  ansible.builtin.service:
    name: docker
    enabled: true
    state: started

- name: Write platform tags for observability
  ansible.builtin.copy:
    dest: /etc/platform-tags
    content: |
      environment={{ common_tags.environment }}
      owner={{ common_tags.owner }}
      compliance={{ common_tags.compliance | default('na') }}
    owner: root
    group: root
    mode: '0644'
