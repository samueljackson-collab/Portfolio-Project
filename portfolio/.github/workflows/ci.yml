name: Production Deployment Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["*"]
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  id-token: write
  actions: read
  checks: write
  security-events: write

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  AWS_REGION: us-west-2
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: portfolio/app

jobs:
  quality:
    name: Quality & Security Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: portfolio/frontend/package-lock.json

      - name: Install frontend deps
        working-directory: portfolio/frontend
        run: npm ci --ignore-scripts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.2 semgrep==1.80.0

      - name: Prettier check
        working-directory: portfolio/frontend
        run: npm run format:check --if-present

      - name: ESLint
        working-directory: portfolio/frontend
        run: npm run lint --if-present

      - name: npm audit
        working-directory: portfolio/frontend
        run: npm audit --production --audit-level=high

      - name: Ruff (Python)
        run: ruff check portfolio

      - name: Semgrep scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"
          path: portfolio

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: portfolio
          format: sarif
          output: trivy-results.sarif

      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: portfolio/infra

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        working-directory: portfolio/infra
        run: |
          tflint --init
          tflint -f compact

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            trivy-results.sarif
          if-no-files-found: ignore

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        working-directory: portfolio
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run unit tests with coverage
        working-directory: portfolio
        run: pytest --maxfail=1 --disable-warnings --cov=backend --cov-report=xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: portfolio/coverage.xml

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: app
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        working-directory: portfolio
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx pytest-cov

      - name: Run integration tests
        working-directory: portfolio
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/app
          REDIS_URL: redis://localhost:6379/0
        run: pytest backend/tests -m "integration or not integration" --cov=backend --cov-append --cov-report=xml

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: portfolio/coverage.xml

  e2e:
    name: End-to-End (Playwright)
    runs-on: ubuntu-latest
    needs: integration
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: portfolio/frontend/package-lock.json

      - name: Install frontend deps
        working-directory: portfolio/frontend
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: portfolio/frontend
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        working-directory: portfolio/frontend
        run: npm run test:e2e --if-present

      - name: Upload e2e report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report
          path: portfolio/frontend/playwright-report
          if-no-files-found: ignore

  docker:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: e2e
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: portfolio
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: CycloneDX for npm
        uses: CycloneDX/gh-node-module-generatebom@v2
        with:
          output: sbom-frontend.xml
          path: portfolio/frontend

      - name: CycloneDX for Python
        run: |
          python -m pip install --upgrade pip
          pip install cyclonedx-bom
          cyclonedx-py --requirements portfolio/requirements.txt --outfile sbom-backend.xml

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-frontend.xml
            sbom-backend.xml

  deploy_staging:
    name: Deploy to Staging (EKS)
    runs-on: ubuntu-latest
    needs: sbom
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STAGING_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ secrets.STAGING_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Helm upgrade
        run: |
          helm upgrade --install portfolio charts/portfolio \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --values charts/portfolio/values-staging.yaml

  performance:
    name: k6 Performance Test
    runs-on: ubuntu-latest
    needs: deploy_staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 smoke test
        run: k6 run performance/smoke.js --address ${{ secrets.STAGING_APP_URL }}

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: k6-results*
          if-no-files-found: ignore

  deploy_production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: performance
    if: github.event_name == 'release'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_PROD_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ secrets.PROD_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Helm upgrade
        run: |
          helm upgrade --install portfolio charts/portfolio \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --values charts/portfolio/values-production.yaml

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [quality, unit, integration, e2e, docker, sbom, deploy_staging, performance, deploy_production]
    if: always()
    steps:
      - name: Slack notification
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {"text": "Production Deployment Pipeline succeeded for ${{ github.ref }}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack failure notification
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {"text": "Production Deployment Pipeline failed for ${{ github.ref }}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Teams notification
        uses: tonistiigi/teams-notify@v1
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          job: ${{ job.status }}
          title: Production Deployment Pipeline
          message: Pipeline completed with status ${{ job.status }} for ${{ github.ref }}
