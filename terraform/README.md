# Terraform Infrastructure Stack

Modular Terraform stack that provisions networking (VPC), application primitives (S3 + optional PostgreSQL), and monitoring guardrails for the portfolio workloads. The stack is intended to run from this directory with GitHub Actions automation for plan/apply and optional OIDC-backed credentials.

## Modules
- **modules/vpc** – Creates the VPC, public/private subnets, routing, and optional NAT gateway.
- **modules/app** – Deploys an encrypted S3 asset bucket and an optional PostgreSQL RDS instance with private networking.
- **modules/monitoring** – Adds CloudWatch log groups, VPC flow logs, SNS alerts, and baseline RDS alarms.
- **examples/full-stack** – Reference configuration showing how to compose the modules for a sandbox environment.

## Prerequisites
- Terraform >= 1.5
- AWS account with permissions to create networking, RDS, CloudWatch, SNS, and IAM resources
- S3 bucket and DynamoDB table for remote state (see backend configuration below)
- AWS credentials available via **OIDC** (recommended) or environment variables compatible with `aws-actions/configure-aws-credentials`

## Backend configuration
Remote state uses S3 with DynamoDB locking. Supply backend values with a `.tfbackend` file or `-backend-config` flags:

```bash
terraform init \
  -backend-config="bucket=<tfstate-bucket>" \
  -backend-config="key=portfolio/terraform.tfstate" \
  -backend-config="region=<aws-region>" \
  -backend-config="dynamodb_table=<lock-table>"
```

## Usage (root module)
1. Copy or export variable values (see `variables.tf`).
2. Initialize without backend (for local validation) or with backend values:
   ```bash
   terraform init -backend=false
   ```
3. Run a plan:
   ```bash
   terraform plan -var="project_name=twisted-monk" -var="environment=dev"
   ```
4. Apply with approvals (locally add `-auto-approve` if desired):
   ```bash
   terraform apply
   ```

### Example stack
From `terraform/examples/full-stack`:
```bash
cd terraform/examples/full-stack
terraform init -backend=false
terraform apply -auto-approve
```

## Security hardening
- S3 bucket blocks public access, enforces versioning, and uses SSE.
- RDS runs in private subnets with encryption, backups, and non-public endpoints.
- VPC Flow Logs stream to CloudWatch with dedicated IAM role.
- GitHub Actions workflows use OIDC-ready configuration and environment protection for apply.
- No secrets are committed; database password can be autogenerated via `random_password`.

## Observability and alerts
- CloudWatch log group for VPC Flow Logs (30-day retention by default).
- SNS topic for alerts with optional email subscribers.
- CPU and free-storage alarms for the RDS instance when enabled.

## Cost considerations
- NAT gateway and RDS instances incur ongoing hourly + data-processing charges. Disable via `enable_nat_gateway=false` or `create_rds=false` for lower-cost sandboxes.
- CloudWatch logs and SNS notifications are typically low cost but scale with volume/subscriptions.
- S3 storage and PUT/LIST costs apply for the asset bucket.

## GitHub Actions automation
- `.github/workflows/terraform.yml` runs fmt, validate, tfsec, and plan on pushes/PRs touching `terraform/`.
- Apply runs only from the `main` branch and requires approval via the protected `production` environment.
- Configure secrets: `AWS_REGION`, `TFSTATE_BUCKET`, `AWS_ROLE_ARN_PLAN`, `AWS_ROLE_ARN_APPLY` (for OIDC), or legacy access keys if needed.

## Diagrams
Architecture, VPC, and component diagrams (Mermaid) live in `docs/architecture/terraform-architecture.md` for quick review.
