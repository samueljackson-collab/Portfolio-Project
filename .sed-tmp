
class TestPrometheusConfigUpdated:
    """Test updated Prometheus configuration with new rule_files"""
    
    def test_prometheus_has_rule_files_section(self):
        """Test that prometheus.yml has rule_files section"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "rule_files" in config
        assert isinstance(config["rule_files"], list)
        assert len(config["rule_files"]) > 0
    
    def test_prometheus_rule_files_paths(self):
        """Test that rule_files paths are correctly specified"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        rule_files = config.get("rule_files", [])
        expected_paths = [
            "/etc/prometheus/rules/recording_rules.yml",
            "/etc/prometheus/rules/alert_rules.yml"
        ]
        
        for expected in expected_paths:
            assert expected in rule_files, f"Expected rule file {expected} not found"
    
    def test_prometheus_scrape_configs_exist(self):
        """Test that scrape_configs section exists and has jobs"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "scrape_configs" in config
        scrape_configs = config["scrape_configs"]
        assert isinstance(scrape_configs, list)
        assert len(scrape_configs) > 0
    
    def test_prometheus_node_exporter_job(self):
        """Test that node_exporter job is properly configured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        scrape_configs = config.get("scrape_configs", [])
        node_exporter_jobs = [job for job in scrape_configs if job.get("job_name") == "node_exporter"]
        
        assert len(node_exporter_jobs) > 0, "node_exporter job not found"
        job = node_exporter_jobs[0]
        assert "static_configs" in job
        assert "metrics_path" in job
        assert job["metrics_path"] == "/metrics"
        assert "scheme" in job
        assert job["scheme"] == "http"
    
    def test_prometheus_kubernetes_apiservers_job(self):
        """Test that kubernetes-apiservers job is configured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        scrape_configs = config.get("scrape_configs", [])
        k8s_jobs = [job for job in scrape_configs if job.get("job_name") == "kubernetes-apiservers"]
        
        assert len(k8s_jobs) > 0, "kubernetes-apiservers job not found"
        job = k8s_jobs[0]
        assert "kubernetes_sd_configs" in job
        assert isinstance(job["kubernetes_sd_configs"], list)
    
    def test_prometheus_global_timeouts_valid(self):
        """Test that global timeout values are valid"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/prometheus.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        global_config = config.get("global", {})
        
        # Check scrape_timeout is less than scrape_interval
        if "scrape_timeout" in global_config and "scrape_interval" in global_config:
            timeout_str = global_config["scrape_timeout"]
            interval_str = global_config["scrape_interval"]
            
            # Convert to seconds for comparison (simple check for common formats)
            timeout_val = int(timeout_str.rstrip('s'))
            interval_val = int(interval_str.rstrip('s'))
            
            assert timeout_val < interval_val, "scrape_timeout should be less than scrape_interval"

class TestAlertRulesYAML:
    """Test alert_rules.yml configuration"""
    
    def test_alert_rules_valid_yaml(self):
        """Test that alert_rules.yml is valid YAML"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        assert config_path.exists(), f"Config not found at {config_path}"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert config is not None
        assert isinstance(config, dict)
    
    def test_alert_rules_has_groups(self):
        """Test that alert_rules.yml has groups section"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "groups" in config
        assert isinstance(config["groups"], list)
        assert len(config["groups"]) > 0
    
    def test_alert_rules_node_alerts_group(self):
        """Test that node_alerts group exists"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        node_alert_groups = [g for g in groups if g.get("name") == "node_alerts"]
        
        assert len(node_alert_groups) > 0, "node_alerts group not found"
        assert "rules" in node_alert_groups[0]
        assert isinstance(node_alert_groups[0]["rules"], list)
    
    def test_node_high_cpu_alert_exists(self):
        """Test that NodeHighCPU alert is defined"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        node_alerts = [g for g in groups if g.get("name") == "node_alerts"][0]
        rules = node_alerts.get("rules", [])
        
        cpu_alerts = [r for r in rules if r.get("alert") == "NodeHighCPU"]
        assert len(cpu_alerts) > 0, "NodeHighCPU alert not found"
        
        alert = cpu_alerts[0]
        assert "expr" in alert
        assert "for" in alert
        assert alert["for"] == "5m"
        assert "labels" in alert
        assert alert["labels"]["severity"] == "critical"
    
    def test_node_high_memory_alert_exists(self):
        """Test that NodeHighMemory alert is defined"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        node_alerts = [g for g in groups if g.get("name") == "node_alerts"][0]
        rules = node_alerts.get("rules", [])
        
        memory_alerts = [r for r in rules if r.get("alert") == "NodeHighMemory"]
        assert len(memory_alerts) > 0, "NodeHighMemory alert not found"
        
        alert = memory_alerts[0]
        assert "expr" in alert
        assert "for" in alert
        assert alert["for"] == "5m"
        assert "labels" in alert
        assert alert["labels"]["severity"] == "warning"
    
    def test_node_disk_running_out_alert_exists(self):
        """Test that NodeDiskRunningOut alert is defined"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        node_alerts = [g for g in groups if g.get("name") == "node_alerts"][0]
        rules = node_alerts.get("rules", [])
        
        disk_alerts = [r for r in rules if r.get("alert") == "NodeDiskRunningOut"]
        assert len(disk_alerts) > 0, "NodeDiskRunningOut alert not found"
        
        alert = disk_alerts[0]
        assert "expr" in alert
        assert "for" in alert
        assert alert["for"] == "10m"
        assert "labels" in alert
        assert alert["labels"]["severity"] == "warning"
    
    def test_alert_rules_have_annotations(self):
        """Test that all alert rules have annotations"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        for group in groups:
            rules = group.get("rules", [])
            for rule in rules:
                if "alert" in rule:  # Only check alert rules, not recording rules
                    assert "annotations" in rule, f"Alert {rule.get('alert')} missing annotations"
                    annotations = rule["annotations"]
                    assert "summary" in annotations or "description" in annotations
    
    def test_alert_expressions_valid_promql(self):
        """Test that alert expressions contain valid PromQL metrics"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/rules/alert_rules.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        for group in groups:
            rules = group.get("rules", [])
            for rule in rules:
                expr = rule.get("expr", "")
                # Basic validation that expression contains metrics
                assert len(expr) > 0, f"Empty expression in rule {rule.get('alert', 'unknown')}"
                # Check for common node_exporter metrics
                if "NodeHighCPU" in rule.get("alert", ""):
                    assert "node_cpu_seconds_total" in expr

class TestInfrastructureAlertsUpdated:
    """Test updated infrastructure_alerts.yml with simplified alerts"""
    
    def test_infrastructure_alerts_simplified(self):
        """Test that infrastructure alerts have been simplified"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            content = f.read()
        
        # Verify extensive comments have been removed
        # (file should be significantly shorter)
        lines = content.split('\n')
        assert len(lines) < 200, "File should be simplified with fewer comment lines"
    
    def test_host_down_alert_configuration(self):
        """Test HostDown alert configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        host_down_alerts = [r for r in rules if r.get("alert") == "HostDown"]
        assert len(host_down_alerts) > 0, "HostDown alert not found"
        
        alert = host_down_alerts[0]
        assert alert["expr"] == "up == 0"
        assert alert["for"] == "2m"
        assert alert["labels"]["severity"] == "critical"
        assert alert["labels"]["component"] == "infrastructure"
    
    def test_cpu_alerts_tiered(self):
        """Test that CPU alerts have warning and critical tiers"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        # Check for warning tier
        warning_alerts = [r for r in rules if r.get("alert") == "HighCPUUsageWarning"]
        assert len(warning_alerts) > 0, "HighCPUUsageWarning not found"
        assert warning_alerts[0]["labels"]["severity"] == "warning"
        assert "80" in warning_alerts[0]["expr"]
        
        # Check for critical tier
        critical_alerts = [r for r in rules if r.get("alert") == "HighCPUUsageCritical"]
        assert len(critical_alerts) > 0, "HighCPUUsageCritical not found"
        assert critical_alerts[0]["labels"]["severity"] == "critical"
        assert "95" in critical_alerts[0]["expr"]
    
    def test_memory_alerts_tiered(self):
        """Test that memory alerts have warning and critical tiers"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        # Check for warning tier
        warning_alerts = [r for r in rules if r.get("alert") == "HighMemoryUsageWarning"]
        assert len(warning_alerts) > 0, "HighMemoryUsageWarning not found"
        assert warning_alerts[0]["labels"]["severity"] == "warning"
        
        # Check for critical tier
        critical_alerts = [r for r in rules if r.get("alert") == "HighMemoryUsageCritical"]
        assert len(critical_alerts) > 0, "HighMemoryUsageCritical not found"
        assert critical_alerts[0]["labels"]["severity"] == "critical"
    
    def test_disk_space_alerts_timing(self):
        """Test that disk space alert timings have been updated"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        # Check warning timing
        warning_alerts = [r for r in rules if r.get("alert") == "DiskSpaceLowWarning"]
        assert len(warning_alerts) > 0
        assert warning_alerts[0]["for"] == "30m", "DiskSpaceLowWarning should wait 30m"
        
        # Check critical timing
        critical_alerts = [r for r in rules if r.get("alert") == "DiskSpaceLowCritical"]
        assert len(critical_alerts) > 0
        assert critical_alerts[0]["for"] == "15m", "DiskSpaceLowCritical should wait 15m"
    
    def test_backup_job_failed_alert(self):
        """Test BackupJobFailed alert configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        backup_alerts = [r for r in rules if r.get("alert") == "BackupJobFailed"]
        assert len(backup_alerts) > 0, "BackupJobFailed alert not found"
        
        alert = backup_alerts[0]
        assert alert["expr"] == "proxmox_backup_job_last_status != 0"
        assert alert["for"] == "1h"
        assert alert["labels"]["severity"] == "critical"
        assert alert["labels"]["component"] == "backup"
    
    def test_high_network_traffic_alert(self):
        """Test HighNetworkTraffic alert configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        network_alerts = [r for r in rules if r.get("alert") == "HighNetworkTraffic"]
        assert len(network_alerts) > 0, "HighNetworkTraffic alert not found"
        
        alert = network_alerts[0]
        assert "rate(node_network_receive_bytes_total[5m])" in alert["expr"]
        assert "100000000" in alert["expr"]  # 100MB/s threshold
        assert alert["for"] == "30m"
    
    def test_service_unreachable_alert(self):
        """Test ServiceUnreachable alert configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        infra_group = [g for g in groups if g.get("name") == "infrastructure"][0]
        rules = infra_group.get("rules", [])
        
        service_alerts = [r for r in rules if r.get("alert") == "ServiceUnreachable"]
        assert len(service_alerts) > 0, "ServiceUnreachable alert not found"
        
        alert = service_alerts[0]
        assert alert["expr"] == "probe_success == 0"
        assert alert["for"] == "5m"
        assert alert["labels"]["severity"] == "critical"
        assert alert["labels"]["component"] == "application"
    
    def test_alert_groups_structure(self):
        """Test that alert groups are properly structured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        group_names = [g.get("name") for g in groups]
        
        assert "infrastructure" in group_names
        assert "backup" in group_names
        assert "application" in group_names
    
    def test_placeholder_groups_are_empty(self):
        """Test that placeholder groups (backup, application) have empty rules"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        
        # Backup group should be empty
        backup_groups = [g for g in groups if g.get("name") == "backup"]
        if backup_groups:
            assert backup_groups[0].get("rules", []) == []
        
        # Application group should be empty
        app_groups = [g for g in groups if g.get("name") == "application"]
        if app_groups:
            assert app_groups[0].get("rules", []) == []
    
    def test_all_alerts_have_runbooks(self):
        """Test that all alerts reference runbooks"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/prometheus/alerts/infrastructure_alerts.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        groups = config.get("groups", [])
        for group in groups:
            rules = group.get("rules", [])
            for rule in rules:
                if "alert" in rule:
                    annotations = rule.get("annotations", {})
                    assert "runbook" in annotations, f"Alert {rule['alert']} missing runbook"
                    assert "runbooks.homelab.local" in annotations["runbook"]

class TestAlertmanagerConfigSimplified:
    """Test simplified Alertmanager configuration"""
    
    def test_alertmanager_simplified(self):
        """Test that alertmanager.yml has been simplified"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            content = f.read()
        
        lines = content.split('\n')
        # Should be much shorter after simplification
        assert len(lines) < 50, "Alertmanager config should be simplified"
    
    def test_alertmanager_global_resolve_timeout(self):
        """Test that global resolve_timeout is set"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "global" in config
        assert "resolve_timeout" in config["global"]
        assert config["global"]["resolve_timeout"] == "5m"
    
    def test_alertmanager_route_basic(self):
        """Test basic route configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "route" in config
        route = config["route"]
        assert "group_by" in route
        assert "alertname" in route["group_by"]
        assert "priority" in route["group_by"]
        assert "receiver" in route
        assert route["receiver"] == "team-email"
    
    def test_alertmanager_timing_defaults(self):
        """Test alert timing configurations"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        route = config.get("route", {})
        assert route.get("group_wait") == "30s"
        assert route.get("group_interval") == "5m"
        assert route.get("repeat_interval") == "4h"
    
    def test_alertmanager_receiver_exists(self):
        """Test that team-email receiver is configured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "receivers" in config
        receivers = config["receivers"]
        assert len(receivers) > 0
        
        receiver_names = [r.get("name") for r in receivers]
        assert "team-email" in receiver_names
    
    def test_alertmanager_email_config(self):
        """Test email configuration in receiver"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        receivers = config.get("receivers", [])
        team_email = [r for r in receivers if r.get("name") == "team-email"][0]
        
        assert "email_configs" in team_email
        email_configs = team_email["email_configs"]
        assert isinstance(email_configs, list)
        assert len(email_configs) > 0
        
        email_config = email_configs[0]
        assert "to" in email_config
        assert "oncall@example.com" in email_config["to"]
    
    def test_alertmanager_placeholder_credentials(self):
        """Test that placeholder credentials are marked for replacement"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/alertmanager/alertmanager.yml"
        
        with open(config_path) as f:
            content = f.read()
        
        # Check for REPLACE markers
        assert "REPLACE" in content, "Config should have REPLACE markers for credentials"

class TestPromtailConfigSimplified:
    """Test simplified Promtail configuration"""
    
    def test_promtail_simplified(self):
        """Test that promtail-config.yml has been simplified"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/loki/promtail-config.yml"
        
        with open(config_path) as f:
            content = f.read()
        
        lines = content.split('\n')
        # Should be much shorter after simplification
        assert len(lines) < 50, "Promtail config should be simplified"
    
    def test_promtail_server_config(self):
        """Test Promtail server configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/loki/promtail-config.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "server" in config
        assert "http_listen_port" in config["server"]
        assert config["server"]["http_listen_port"] == 9080
    
    def test_promtail_positions_file(self):
        """Test Promtail positions file configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/loki/promtail-config.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "positions" in config
        assert "filename" in config["positions"]
        assert config["positions"]["filename"] == "/tmp/positions.yaml"
    
    def test_promtail_loki_client(self):
        """Test Promtail Loki client configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/loki/promtail-config.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "clients" in config
        clients = config["clients"]
        assert isinstance(clients, list)
        assert len(clients) > 0
        
        client = clients[0]
        assert "url" in client
        assert "loki:3100" in client["url"]
    
    def test_promtail_scrape_config_basic(self):
        """Test basic scrape configuration"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/loki/promtail-config.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "scrape_configs" in config
        scrape_configs = config["scrape_configs"]
        assert isinstance(scrape_configs, list)
        assert len(scrape_configs) > 0
        
        job = scrape_configs[0]
        assert "job_name" in job
        assert job["job_name"] == "system"
        assert "static_configs" in job

class TestGrafanaDatasources:
    """Test Grafana datasources configuration"""
    
    def test_datasources_valid_yaml(self):
        """Test that datasources.yml is valid YAML"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/grafana/provisioning/datasources.yml"
        assert config_path.exists(), f"Config not found at {config_path}"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert config is not None
        assert isinstance(config, dict)
    
    def test_datasources_api_version(self):
        """Test that datasources.yml has apiVersion"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/grafana/provisioning/datasources.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "apiVersion" in config
        assert config["apiVersion"] == 1
    
    def test_datasources_list(self):
        """Test that datasources are properly configured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/grafana/provisioning/datasources.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        assert "datasources" in config
        datasources = config["datasources"]
        assert isinstance(datasources, list)
        assert len(datasources) > 0
    
    def test_prometheus_datasource(self):
        """Test that Prometheus datasource is configured"""
        config_path = BASE_PATH / "projects/01-sde-devops/PRJ-SDE-002/assets/grafana/provisioning/datasources.yml"
        
        with open(config_path) as f:
            config = yaml.safe_load(f)
        
        datasources = config.get("datasources", [])
        prom_datasources = [ds for ds in datasources if ds.get("name") == "Prometheus"]
        
        assert len(prom_datasources) > 0, "Prometheus datasource not found"
        prom = prom_datasources[0]
        
        assert prom["type"] == "prometheus"
        assert prom["access"] == "proxy"
        assert "prometheus:9090" in prom["url"]
        assert prom["isDefault"] == True
        assert prom["editable"] == False
