AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: P08 Serverless Data Processing Platform

Globals:
  Function:
    Runtime: python3.10
    Timeout: 300
    MemorySize: 512
    Environment:
      Variables:
        METADATA_TABLE: !Ref MetadataTable
        PROCESSED_BUCKET: !Ref ProcessedBucket
        DLQ_BUCKET: !Ref ErrorBucket
    Tags:
      Project: P08
      Environment: Production

Parameters:
  RawBucketName:
    Type: String
    Default: p08-raw-data-bucket
  ProcessedBucketName:
    Type: String
    Default: p08-processed-data-bucket
  ErrorBucketName:
    Type: String
    Default: p08-error-data-bucket

Resources:
  # S3 Buckets
  RawBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref RawBucketName
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true

  ProcessedBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref ProcessedBucketName
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  ErrorBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref ErrorBucketName
      VersioningConfiguration:
        Status: Enabled

  # DynamoDB Metadata Table
  MetadataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: etl-metadata
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: execution_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: execution_id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE

  # Lambda Functions
  IngestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: P08-Ingest
      CodeUri: lambda/ingest/
      Handler: handler.lambda_handler
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref RawBucketName
        - DynamoDBWritePolicy:
            TableName: !Ref MetadataTable
      Events:
        S3Event:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - Object Created
              detail:
                bucket:
                  name:
                    - !Ref RawBucket

  ValidateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: P08-Validate
      CodeUri: lambda/validate/
      Handler: handler.lambda_handler
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref RawBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref MetadataTable

  TransformFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: P08-Transform
      CodeUri: lambda/transform/
      Handler: handler.lambda_handler
      MemorySize: 1024
      Timeout: 600
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref RawBucketName
        - S3WritePolicy:
            BucketName: !Ref ProcessedBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref MetadataTable

  OutputFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: P08-Output
      CodeUri: lambda/output/
      Handler: handler.lambda_handler
      Policies:
        - S3WritePolicy:
            BucketName: !Ref ProcessedBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref MetadataTable

  # Step Functions State Machine
  ETLStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: P08-ETL-Workflow
      DefinitionUri: stepfunctions/etl_workflow.asl.json
      DefinitionSubstitutions:
        ValidateFunctionArn: !GetAtt ValidateFunction.Arn
        TransformFunctionArn: !GetAtt TransformFunction.Arn
        OutputFunctionArn: !GetAtt OutputFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref ValidateFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref TransformFunction
        - LambdaInvokePolicy:
            FunctionName: !OutputFunction
      Events:
        S3Trigger:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - Object Created
              detail:
                bucket:
                  name:
                    - !Ref RawBucket

Outputs:
  StateMachineArn:
    Description: ARN of Step Functions state machine
    Value: !GetAtt ETLStateMachine.Arn
  RawBucketName:
    Description: Name of raw data bucket
    Value: !Ref RawBucket
  ProcessedBucketName:
    Description: Name of processed data bucket
    Value: !Ref ProcessedBucket
  MetadataTableName:
    Description: Name of DynamoDB metadata table
    Value: !Ref MetadataTable
