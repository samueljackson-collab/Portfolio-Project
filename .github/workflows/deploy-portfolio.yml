name: Deploy Portfolio

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Lint and test
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pylint black flake8

      - name: Run linters
        run: |
          echo "Running Python linters..."
          find . -name "*.py" -type f | xargs pylint --disable=all --enable=E || true
          find . -name "*.py" -type f | xargs flake8 --max-line-length=120 || true

      - name: Run tests
        run: |
          echo "Running tests..."
          pytest tests/ -v || true

  # Build documentation
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material pymdown-extensions

      - name: Build documentation
        run: |
          if [ -f "mkdocs.yml" ]; then
            mkdocs build
          else
            echo "No mkdocs.yml found, skipping documentation build"
          fi

      - name: Upload documentation artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: site/
          retention-days: 7

  # Deploy to GitHub Pages
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material pymdown-extensions

      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

  # Test Docker Compose stack
  test-docker:
    name: Test Docker Stack
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
        continue-on-error: true
        
      - name: Wait for Docker Hub (retry logic)
        run: |
          echo "Verifying Docker Hub connectivity..."
          for i in {1..3}; do
            if docker pull hello-world:latest; then
              echo "Docker Hub is accessible"
              break
            else
              echo "Attempt $i failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
        continue-on-error: true

      - name: Start Docker Compose stack
        run: |
          if [ -f "compose.demo.yml" ]; then
            echo "Starting demo stack..."
            docker compose -f compose.demo.yml up -d --wait || true
            sleep 30
          else
            echo "No compose.demo.yml found, skipping"
          fi

      - name: Run smoke tests
        run: |
          if [ -f "scripts/smoke-test.sh" ]; then
            bash scripts/smoke-test.sh || true
          fi

      - name: Show container logs
        if: always()
        run: |
          if [ -f "compose.demo.yml" ]; then
            docker compose -f compose.demo.yml logs || true
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f "compose.demo.yml" ]; then
            docker compose -f compose.demo.yml down -v || true
          fi

  # Create release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, build-docs, deploy-pages]
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'release:')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from commit message
        id: version
        run: |
          VERSION=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'release: v\K[0-9]+\.[0-9]+\.[0-9]+' || echo "0.0.1")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create release archive
        run: |
          if [ -f "scripts/release-build.sh" ]; then
            bash scripts/release-build.sh
          else
            tar -czf enterprise-portfolio.tar.gz \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='venv' \
              --exclude='__pycache__' \
              .
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            enterprise-portfolio.tar.gz
            enterprise-portfolio.zip
            enterprise-portfolio_manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
