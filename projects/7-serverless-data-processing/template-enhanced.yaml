AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Serverless Data Processing Platform with Step Functions and API Gateway

Globals:
  Function:
    Timeout: 30
    Runtime: python3.11
    MemorySize: 512
    Environment:
      Variables:
        LOG_LEVEL: INFO
        ENVIRONMENT: !Ref Environment
    Tracing: Active
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization'"
      AllowOrigin: "'*'"

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - production

Resources:
  # Cognito User Pool for authentication
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-users-${Environment}'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${AWS::StackName}-client-${Environment}'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  # S3 Bucket for processed data
  ProcessedDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-processed-${Environment}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # SQS Queues
  EventQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-events-${Environment}'
      VisibilityTimeout: 180
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DeadLetterQueue.Arn
        maxReceiveCount: 3

  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-dlq-${Environment}'
      MessageRetentionPeriod: 1209600

  # DynamoDB Table
  MetricsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-metrics-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: metric_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: metric_id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  # SNS Topic
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${AWS::StackName}-notifications-${Environment}'

  # Step Functions - Workflow Tasks
  ValidateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.validate_handler
      Description: Validate workflow input

  TransformFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.transform_handler
      Description: Transform data

  EnrichFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.enrich_handler
      Description: Enrich data

  AggregateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.aggregate_handler
      Description: Aggregate results

  RejectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.reject_handler
      Description: Handle rejected data

  ErrorHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: step_functions_tasks.error_handler
      Description: Handle workflow errors

  # Step Functions State Machine
  ProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub '${AWS::StackName}-workflow-${Environment}'
      DefinitionUri: statemachine/workflow.asl.json
      DefinitionSubstitutions:
        ValidateFunction: !GetAtt ValidateFunction.Arn
        TransformFunction: !GetAtt TransformFunction.Arn
        EnrichFunction: !GetAtt EnrichFunction.Arn
        AggregateFunction: !GetAtt AggregateFunction.Arn
        RejectFunction: !GetAtt RejectFunction.Arn
        ErrorHandlerFunction: !GetAtt ErrorHandlerFunction.Arn
        MetricsTable: !Ref MetricsTable
        NotificationTopic: !Ref NotificationTopic
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref ValidateFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref TransformFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref EnrichFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref AggregateFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref RejectFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ErrorHandlerFunction
        - DynamoDBWritePolicy:
            TableName: !Ref MetricsTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName

  # API Gateway Functions
  StartProcessingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: api_handlers.start_processing_handler
      Description: Start data processing via API
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref ProcessingStateMachine
          METRICS_TABLE_NAME: !Ref MetricsTable
      Policies:
        - StepFunctionsExecutionPolicy:
            StateMachineName: !GetAtt ProcessingStateMachine.Name
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref ProcessingApi
            Path: /process
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: api_handlers.get_status_handler
      Description: Get job status via API
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref ProcessingStateMachine
      Policies:
        - StepFunctionsExecutionPolicy:
            StateMachineName: !GetAtt ProcessingStateMachine.Name
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref ProcessingApi
            Path: /status/{execution_arn}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  ListJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: api_handlers.list_jobs_handler
      Description: List processing jobs
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref ProcessingStateMachine
      Policies:
        - StepFunctionsExecutionPolicy:
            StateMachineName: !GetAtt ProcessingStateMachine.Name
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref ProcessingApi
            Path: /jobs
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  GetMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: api_handlers.get_metrics_handler
      Description: Get processing metrics
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MetricsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref ProcessingApi
            Path: /metrics/{metric_id}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # API Gateway
  ProcessingApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub '${AWS::StackName}-api-${Environment}'
      StageName: !Ref Environment
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
        DefaultAuthorizer: CognitoAuthorizer
      AccessLogSetting:
        DestinationArn: !GetAtt ApiLogGroup.Arn
        Format: '$context.requestId $context.error.message $context.error.messageString'
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true

  # CloudWatch Log Group for API
  ApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${AWS::StackName}-${Environment}'
      RetentionInDays: 30

  # CloudWatch Alarms
  ErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-error-rate-${Environment}'
      AlarmDescription: Alert when error rate is high
      MetricName: ExecutionsFailed
      Namespace: AWS/States
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref ProcessingStateMachine
      AlarmActions:
        - !Ref NotificationTopic

  ApiErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-api-errors-${Environment}'
      AlarmDescription: Alert when API error rate is high
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref ProcessingApi
      AlarmActions:
        - !Ref NotificationTopic

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${ProcessingApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient

  StateMachineArn:
    Description: Step Functions State Machine ARN
    Value: !Ref ProcessingStateMachine

  ProcessedDataBucket:
    Description: S3 bucket for processed data
    Value: !Ref ProcessedDataBucket

  MetricsTableName:
    Description: DynamoDB metrics table name
    Value: !Ref MetricsTable
