---
- name: Prepare Active Directory lab
  hosts: domain_controllers
  become: true
  tasks:
    - name: Install AD DS role
      ansible.windows.win_feature:
        name: AD-Domain-Services
        state: present

    - name: Promote server to domain controller (lab.local)
      ansible.windows.win_domain:
        dns_domain_name: lab.local
        safe_mode_password: "{{ vault_safemode_password }}"
      register: domain_setup

    - name: Reboot after promotion
      ansible.windows.win_reboot:
        msg: "Rebooting after AD promotion"
      when: domain_setup.changed
