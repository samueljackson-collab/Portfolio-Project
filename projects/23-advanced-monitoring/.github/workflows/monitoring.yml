name: Deploy Monitoring Stack

on:
  push:
    branches: [main]
    paths:
      - 'projects/23-advanced-monitoring/**'
  pull_request:
    branches: [main]
    paths:
      - 'projects/23-advanced-monitoring/**'

env:
  KUBE_NAMESPACE: monitoring

jobs:
  validate:
    name: Validate Monitoring Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Prometheus rules
        run: |
          docker run --rm -v $(pwd)/projects/23-advanced-monitoring/alerts:/alerts \
            prom/prometheus:latest promtool check rules /alerts/portfolio_rules.yml

      - name: Validate Grafana dashboards
        uses: grafana/dashboard-linter-action@v1
        with:
          path: projects/23-advanced-monitoring/dashboards/*.json

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: projects/23-advanced-monitoring/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning

  deploy-prometheus:
    name: Deploy Prometheus
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Create monitoring namespace
        run: |
          kubectl create namespace ${{ env.KUBE_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Prometheus Operator
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --set prometheus.prometheusSpec.retention=30d \
            --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=50Gi \
            --wait

      - name: Apply custom Prometheus rules
        run: |
          kubectl apply -f projects/23-advanced-monitoring/alerts/portfolio_rules.yml \
            -n ${{ env.KUBE_NAMESPACE }}

  deploy-grafana:
    name: Deploy Grafana Dashboards
    runs-on: ubuntu-latest
    needs: deploy-prometheus

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Create Grafana dashboards ConfigMap
        run: |
          kubectl create configmap grafana-dashboards \
            --from-file=projects/23-advanced-monitoring/dashboards/ \
            -n ${{ env.KUBE_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Restart Grafana to load dashboards
        run: |
          kubectl rollout restart deployment/prometheus-grafana \
            -n ${{ env.KUBE_NAMESPACE }}
          kubectl rollout status deployment/prometheus-grafana \
            -n ${{ env.KUBE_NAMESPACE }}

  deploy-loki:
    name: Deploy Loki for Log Aggregation
    runs-on: ubuntu-latest
    needs: deploy-prometheus

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Deploy Loki Stack
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

          helm upgrade --install loki grafana/loki-stack \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --set loki.persistence.enabled=true \
            --set loki.persistence.size=50Gi \
            --set promtail.enabled=true \
            --wait

  deploy-opentelemetry:
    name: Deploy OpenTelemetry Collector
    runs-on: ubuntu-latest
    needs: deploy-prometheus

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Deploy OpenTelemetry Operator
        run: |
          kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/latest/download/opentelemetry-operator.yaml

      - name: Wait for operator
        run: |
          kubectl wait --for=condition=available --timeout=300s \
            deployment/opentelemetry-operator-controller-manager \
            -n opentelemetry-operator-system

  health-check:
    name: Verify Monitoring Stack Health
    runs-on: ubuntu-latest
    needs: [deploy-grafana, deploy-loki, deploy-opentelemetry]

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Check Prometheus health
        run: |
          kubectl port-forward -n ${{ env.KUBE_NAMESPACE }} \
            svc/prometheus-kube-prometheus-prometheus 9090:9090 &
          sleep 5
          curl -f http://localhost:9090/-/healthy || exit 1

      - name: Check Grafana health
        run: |
          kubectl port-forward -n ${{ env.KUBE_NAMESPACE }} \
            svc/prometheus-grafana 3000:80 &
          sleep 5
          curl -f http://localhost:3000/api/health || exit 1

      - name: Verify dashboards loaded
        run: |
          DASHBOARD_COUNT=$(kubectl get configmap grafana-dashboards \
            -n ${{ env.KUBE_NAMESPACE }} \
            -o jsonpath='{.data}' | jq 'keys | length')
          echo "Loaded $DASHBOARD_COUNT dashboards"
          [ "$DASHBOARD_COUNT" -gt 0 ] || exit 1

      - name: Test alert rules
        run: |
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} \
            prometheus-prometheus-kube-prometheus-prometheus-0 \
            -- promtool check rules /etc/prometheus/rules/prometheus-*/portfolio_rules.yml
