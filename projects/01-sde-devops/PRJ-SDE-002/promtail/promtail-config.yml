# Promtail configuration for Docker and system log collection with label hygiene to avoid cardinality blowups.
server:
  http_listen_port: 9080
  grpc_listen_port: 0 # Disabled to reduce exposed surfaces; HTTP only for readiness.

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 102400 # 100KB batches balance latency vs efficiency.

scrape_configs:
  - job_name: docker-logs
    static_configs:
      - targets: [localhost]
        labels:
          job: docker-logs
          host: ${HOSTNAME}
          environment: ${ENVIRONMENT}
          __path__: /var/lib/docker/containers/*/*-json.log
    pipeline_stages:
      - json:
          expressions:
            log: log
            stream: stream
            time: time
            attrs: attrs
      - timestamp:
          source: time
          format: RFC3339Nano
      - labels:
          stream:
          container: attrs.container_name
          image: attrs.image
      - multiline:
          firstline: '^(?P<ts>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)'
          max_wait_time: 3s
      - labeldrop:
          - attrs
          - filename
          - stream
        # Labeldrop removes noisy keys to control cardinality; container/image retained for filtering.

  - job_name: system-logs
    static_configs:
      - targets: [localhost]
        labels:
          job: varlogs
          host: ${HOSTNAME}
          environment: ${ENVIRONMENT}
          __path__: /var/log/*.log

  - job_name: auth-logs
    static_configs:
      - targets: [localhost]
        labels:
          job: authlog
          host: ${HOSTNAME}
          environment: ${ENVIRONMENT}
          __path__: /var/log/auth.log

# Example LogQL queries (documentation aid):
# 1) Recent errors: {job="docker-logs", level="error"} | logfmt
# 2) Container log volume: sum(rate({job="docker-logs"}[5m])) by (container)
# 3) Auth failures: {job="authlog"} |= "Failed password"
