# Promtail configuration for homelab log shippers
# -----------------------------------------------
# This configuration collects logs from system files, the journal, Docker
# containers, and application specific paths. Extensive comments explain each
# section for future operators.

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://192.168.1.30:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s
    external_labels:
      cluster: homelab
      environment: production

scrape_configs:
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          host: "${HOSTNAME}"
          __path__: /var/log/syslog
    pipeline_stages:
      - labeldrop:
          - filename

  - job_name: auth-log
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth
          host: "${HOSTNAME}"
          __path__: /var/log/auth.log
    pipeline_stages:
      - match:
          selector: '{job="auth"}'
          stages:
            - regex:
                expression: '.*sshd\\[(?P<pid>\\d+)\].*'
            - labels:
                pid:
            - regex:
                expression: '.*for (?P<user>\\w+) from (?P<source_ip>[\\d\.]+).*'
            - labels:
                user:
                source_ip:

  - job_name: systemd-services
    journal:
      json: false
      max_age: 12h
      labels:
        job: systemd
        host: "${HOSTNAME}"
      path: /var/log/journal
      matches:
        - _SYSTEMD_UNIT=nginx.service
        - _SYSTEMD_UNIT=postgresql.service
        - _SYSTEMD_UNIT=docker.service
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        target_label: unit

  - job_name: docker-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          host: "${HOSTNAME}"
          __path__: /var/lib/docker/containers/*/*.log
    pipeline_stages:
      - match:
          selector: '{job="docker"}'
          stages:
            - json:
                expressions:
                  log: log
                  stream: stream
                  time: time
                  attrs: attrs
            - labels:
                stream:
            - output:
                source: log
            - timestamp:
                source: time
                format: RFC3339Nano
            - json:
                expressions:
                  container_name: attrs.name
            - labels:
                container_name:

  - job_name: nginx-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx-access
          host: "${HOSTNAME}"
          __path__: /var/log/nginx/access.log
    pipeline_stages:
      - regex:
          expression: '^(?P<client_ip>[^ ]*) [^ ]* [^ ]* \[(?P<timestamp>[^\]]*)\] "(?P<method>[A-Z]+) (?P<path>[^ ]*) [^"]*" (?P<status>\\d{3}) (?P<size>\\d+|-)'
      - labels:
          client_ip:
          method:
          path:
          status:
      - metrics:
          - counter:
              name: nginx_requests_total
              help: Total number of processed requests
              labels:
                status:
                method:
      - timestamp:
          source: timestamp
          format: RFC3339

# Example queries for Grafana dashboards:
# - {job="syslog"} |~ "error"
# - rate(nginx_requests_total[5m]) by (status)
# - count_over_time({job="auth",user="root"}[1h])
