###############################################################################
# Grafana Dashboard Provisioning
# Auto-provision dashboards on Grafana startup
###############################################################################
#
# Purpose: Automatically load dashboards from filesystem
# Documentation: https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards
#
# Advantages:
#   - Version control dashboards as JSON
#   - Consistent across environments
#   - No manual dashboard imports
#   - Backup-friendly (dashboards in git)
#
# Usage:
#   1. Place dashboard JSON files in configured path
#   2. Grafana auto-loads on startup
#   3. Changes detected and reloaded automatically
#
###############################################################################

apiVersion: 1

###############################################################################
# DASHBOARD PROVIDERS
###############################################################################
providers:
  ###########################################################################
  # Default Dashboard Provider
  # Loads dashboards from /var/lib/grafana/dashboards/
  ###########################################################################
  - name: 'default'
    # orgId: Organization ID
    # 1: Default organization
    orgId: 1

    # folder: Folder name in Grafana UI
    # Empty string: Root folder (General)
    # Specify name: Custom folder (e.g., "Monitoring")
    folder: 'Monitoring Stack'

    # folderUid: Unique folder identifier (optional)
    # Used for stable folder references across environments
    folderUid: 'monitoring-folder'

    # type: Provider type
    # file: Load from filesystem (most common)
    type: file

    # disableDeletion: Prevent dashboard deletion via UI
    # true: Dashboards are read-only in UI (recommended)
    # false: Allow UI deletion (not recommended, breaks GitOps)
    disableDeletion: true

    # updateIntervalSeconds: How often to scan for changes
    # 30: Check every 30 seconds for new/modified dashboards
    # Lower values: Faster updates, more CPU
    # Higher values: Less overhead, slower updates
    updateIntervalSeconds: 30

    # allowUiUpdates: Allow editing dashboards in UI
    # false: Dashboards are read-only (recommended for GitOps)
    #        Users can edit temporarily but changes don't persist
    # true: UI changes saved to filesystem (if permissions allow)
    allowUiUpdates: false

    # options:
    #   path: Directory containing dashboard JSON files
    #   Must be readable by Grafana process
    #   Docker: Map this path in volumes
    options:
      path: /var/lib/grafana/dashboards

      # foldersFromFilesStructure: Create folders from directory structure
      # true: Subdirectories become folders in Grafana
      #       /dashboards/infra/ → "infra" folder in Grafana
      # false: All dashboards in single folder
      foldersFromFilesStructure: true

  ###########################################################################
  # Infrastructure Dashboards
  # Separate provider for infrastructure-specific dashboards
  ###########################################################################
  - name: 'infrastructure'
    orgId: 1
    folder: 'Infrastructure'
    folderUid: 'infra-folder'
    type: file
    disableDeletion: true
    updateIntervalSeconds: 60
    allowUiUpdates: false
    options:
      path: /var/lib/grafana/dashboards/infrastructure

  ###########################################################################
  # Application Dashboards (Optional)
  # Separate provider for application-specific dashboards
  ###########################################################################
  # - name: 'applications'
  #   orgId: 1
  #   folder: 'Applications'
  #   folderUid: 'apps-folder'
  #   type: file
  #   disableDeletion: true
  #   updateIntervalSeconds: 60
  #   allowUiUpdates: false
  #   options:
  #     path: /var/lib/grafana/dashboards/applications

  ###########################################################################
  # Business Dashboards (Optional)
  # Executive/business-level dashboards
  ###########################################################################
  # - name: 'business'
  #   orgId: 1
  #   folder: 'Business Metrics'
  #   folderUid: 'business-folder'
  #   type: file
  #   disableDeletion: true
  #   updateIntervalSeconds: 300  # Less frequent updates
  #   allowUiUpdates: false
  #   options:
  #     path: /var/lib/grafana/dashboards/business

###############################################################################
# DASHBOARD JSON FORMAT
###############################################################################
#
# Dashboard JSON Structure:
# {
#   "dashboard": {
#     "title": "Dashboard Title",
#     "uid": "unique-dashboard-id",  # Stable UID for links/API
#     "version": 1,
#     "panels": [...],
#     "templating": {...},
#     "annotations": {...},
#     "refresh": "30s",
#     "timezone": "browser",
#     "editable": false
#   },
#   "folderId": null,
#   "folderUid": "",
#   "overwrite": true  # Overwrite existing dashboard with same UID
# }
#
# Exporting Dashboards:
#   1. Create dashboard in Grafana UI
#   2. Dashboard Settings → JSON Model → Copy
#   3. Save to file: dashboard-name.json
#   4. Place in provisioning path
#   5. Grafana auto-loads on next scan
#
# Dashboard Variables (Template Variables):
#   Use for dynamic dashboards:
#   - $instance: Selected instance from dropdown
#   - $interval: Auto-calculated time interval
#   - $__interval: Grafana's automatic interval
#
# Best Practices:
#   - Use descriptive dashboard titles
#   - Set unique UIDs (for stable links)
#   - Include descriptions in panels
#   - Use template variables for filtering
#   - Set appropriate refresh rates
#   - Test queries for performance
#   - Document dashboard purpose
#
###############################################################################

###############################################################################
# TROUBLESHOOTING
###############################################################################
#
# Dashboards not loading:
#   1. Check path exists and is readable:
#      docker exec monitoring-grafana ls -la /var/lib/grafana/dashboards/
#   2. Verify JSON syntax: jq . dashboard.json
#   3. Check Grafana logs: docker logs monitoring-grafana | grep -i dashboard
#   4. Verify file permissions: chmod 644 dashboard.json
#
# Dashboards not updating:
#   1. Check updateIntervalSeconds setting
#   2. Force reload: Restart Grafana
#   3. Verify file modification time: ls -l dashboard.json
#   4. Check for JSON syntax errors
#
# Dashboard shows "Dashboard not found":
#   1. Verify dashboard UID matches
#   2. Check folder configuration
#   3. Ensure dashboard JSON includes required fields
#   4. Review provisioning logs in Grafana
#
# UI edits not saving:
#   - By design if allowUiUpdates: false
#   - Temporary edits allowed, but not persisted
#   - Export JSON and save to filesystem for permanent changes
#
# Permission errors:
#   1. Ensure Grafana user (UID 472) can read files
#   2. In Docker: chown -R 472:472 /path/to/dashboards
#   3. Or: chmod 755 directories, chmod 644 JSON files
#
###############################################################################
