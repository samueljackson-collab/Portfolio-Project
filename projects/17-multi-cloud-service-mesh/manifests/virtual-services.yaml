# Virtual Services for Traffic Management
# Demonstrates canary deployments, A/B testing, and traffic mirroring
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: productpage
  namespace: bookinfo
spec:
  hosts:
    - productpage
  http:
    - timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-4xx,503
      route:
        - destination:
            host: productpage
            port:
              number: 9080
---
# Reviews service with canary deployment (90/10 split)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
  namespace: bookinfo
spec:
  hosts:
    - reviews
  http:
    - route:
        - destination:
            host: reviews
            subset: stable
          weight: 90
        - destination:
            host: reviews
            subset: canary
          weight: 10
---
# Ratings service with header-based routing (A/B testing)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings
  namespace: bookinfo
spec:
  hosts:
    - ratings
  http:
    # Route beta users to v2
    - match:
        - headers:
            x-user-type:
              exact: beta
      route:
        - destination:
            host: ratings
            subset: v2
    # Route internal users to v2
    - match:
        - headers:
            x-internal:
              exact: "true"
      route:
        - destination:
            host: ratings
            subset: v2
    # Default route to v1
    - route:
        - destination:
            host: ratings
            subset: v1
---
# Details service with traffic mirroring (shadow traffic)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: details
  namespace: bookinfo
spec:
  hosts:
    - details
  http:
    - route:
        - destination:
            host: details
            subset: v1
      mirror:
        host: details
        subset: v2
      mirrorPercentage:
        value: 100.0
---
# Ingress Gateway VirtualService for external access
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo-gateway
  namespace: bookinfo
spec:
  hosts:
    - "bookinfo.example.com"
    - "*.bookinfo.example.com"
  gateways:
    - bookinfo-gateway
  http:
    - match:
        - uri:
            prefix: /productpage
        - uri:
            prefix: /static
        - uri:
            exact: /login
        - uri:
            exact: /logout
        - uri:
            prefix: /api/v1/products
      route:
        - destination:
            host: productpage
            port:
              number: 9080
      corsPolicy:
        allowOrigins:
          - exact: "https://bookinfo.example.com"
        allowMethods:
          - GET
          - POST
          - OPTIONS
        allowHeaders:
          - authorization
          - content-type
        maxAge: "24h"
---
# Cross-cluster service routing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-cross-cluster
  namespace: bookinfo
spec:
  hosts:
    - reviews.bookinfo.svc.cluster.local
  http:
    - match:
        - headers:
            x-region:
              exact: us-west-2
      route:
        - destination:
            host: reviews.bookinfo.svc.cluster.local
            subset: cluster-west
    - match:
        - headers:
            x-region:
              exact: us-east-1
      route:
        - destination:
            host: reviews.bookinfo.svc.cluster.local
            subset: cluster-east
    # Default: locality-aware load balancing
    - route:
        - destination:
            host: reviews.bookinfo.svc.cluster.local
