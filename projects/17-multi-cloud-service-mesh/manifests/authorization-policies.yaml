# Authorization Policies for Zero-Trust Security
# Implements least-privilege access control across the mesh
---
# Deny all traffic by default (zero-trust baseline)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: bookinfo
spec:
  {}  # Empty spec = deny all
---
# Allow ingress gateway to access productpage
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-productpage
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: productpage
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
      to:
        - operation:
            methods:
              - GET
              - POST
            paths:
              - "/productpage"
              - "/static/*"
              - "/login"
              - "/logout"
              - "/api/v1/products/*"
---
# Allow productpage to access reviews
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-productpage-reviews
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: reviews
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/bookinfo/sa/bookinfo-productpage"
      to:
        - operation:
            methods:
              - GET
            paths:
              - "/reviews/*"
---
# Allow productpage to access details
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-productpage-details
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: details
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/bookinfo/sa/bookinfo-productpage"
      to:
        - operation:
            methods:
              - GET
            paths:
              - "/details/*"
---
# Allow reviews to access ratings
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-reviews-ratings
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: ratings
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/bookinfo/sa/bookinfo-reviews"
      to:
        - operation:
            methods:
              - GET
            paths:
              - "/ratings/*"
---
# Allow Prometheus to scrape metrics from all services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-prometheus-metrics
  namespace: bookinfo
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/prometheus"
      to:
        - operation:
            methods:
              - GET
            paths:
              - "/metrics"
              - "/stats/prometheus"
---
# Allow health checks from kubelet
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-checks
  namespace: bookinfo
spec:
  action: ALLOW
  rules:
    - to:
        - operation:
            methods:
              - GET
            paths:
              - "/health"
              - "/healthz"
              - "/ready"
              - "/readyz"
              - "/live"
              - "/livez"
---
# Cross-cluster authorization for east-west traffic
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-cross-cluster
  namespace: bookinfo
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            # Allow traffic from trusted mesh IDs
            principals:
              - "spiffe://cluster.local/ns/bookinfo/sa/bookinfo-productpage"
              - "spiffe://cluster-west.local/ns/bookinfo/sa/bookinfo-productpage"
              - "spiffe://cluster-east.local/ns/bookinfo/sa/bookinfo-productpage"
      when:
        - key: request.headers[x-forwarded-client-cert]
          notValues:
            - ""
---
# Deny access from unknown namespaces
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-unknown-namespaces
  namespace: bookinfo
spec:
  action: DENY
  rules:
    - from:
        - source:
            notNamespaces:
              - bookinfo
              - istio-system
              - monitoring
      when:
        - key: source.namespace
          notValues:
            - bookinfo
            - istio-system
            - monitoring
---
# Rate limiting policy (using Envoy rate limit)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: rate-limit-productpage
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: productpage
  action: CUSTOM
  provider:
    name: rate-limit-provider
  rules:
    - to:
        - operation:
            paths:
              - "/api/*"
