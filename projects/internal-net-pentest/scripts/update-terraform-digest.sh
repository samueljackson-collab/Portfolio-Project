#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TERRAFORM_FILE="${ROOT_DIR}/terraform/main.tf"
IMAGE_REPO="${IMAGE_REPO:-ghcr.io/samueljackson-collab/internal-net-pentest-api}"

if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <sha256-digest>"
  exit 1
fi

DIGEST="$1"

if [[ "${DIGEST}" != sha256:* ]]; then
  echo "Digest must include sha256 prefix (e.g., sha256:abc123...)"
  exit 1
fi

if [[ ! -f "${TERRAFORM_FILE}" ]]; then
  echo "Terraform file not found: ${TERRAFORM_FILE}"
  exit 1
fi

perl -0pi -e "s|${IMAGE_REPO}@sha256:[a-f0-9]{64}|${IMAGE_REPO}@${DIGEST}|g" "${TERRAFORM_FILE}"

echo "Updated image digest to ${IMAGE_REPO}@${DIGEST}"
