import pathlib
import sys

import pytest
from fastapi.testclient import TestClient

sys.path.append(str(pathlib.Path(__file__).resolve().parents[1]))
from app.main import app

client = TestClient(app)


@pytest.fixture(autouse=True)
def reset_state():
    client.delete("/reset")


def authenticate() -> dict:
    response = client.post(
        "/auth/token", json={"username": "operator", "password": "changeme"}
    )
    assert response.status_code == 200
    token = response.json()["access_token"]
    return {"Authorization": f"Bearer {token}"}


def create_host(headers):
    payload = {
        "hostname": "db-01",
        "ip_address": "10.0.0.2",
        "operating_system": "Ubuntu",
        "criticality": "high",
    }
    resp = client.post("/hosts", json=payload, headers=headers)
    assert resp.status_code == 200
    return resp.json()


def test_health_endpoint():
    resp = client.get("/health")
    assert resp.status_code == 200
    assert resp.json()["status"] == "ok"


def test_host_crud_with_jwt():
    headers = authenticate()
    created = create_host(headers)
    host_id = created["id"]

    fetched = client.get(f"/hosts/{host_id}", headers=headers)
    assert fetched.status_code == 200
    assert fetched.json()["hostname"] == "db-01"

    updated = client.put(
        f"/hosts/{host_id}",
        json={
            "hostname": "db-02",
            "ip_address": "10.0.0.3",
            "operating_system": "Ubuntu",
            "criticality": "medium",
        },
        headers=headers,
    )
    assert updated.status_code == 200
    assert updated.json()["hostname"] == "db-02"

    deleted = client.delete(f"/hosts/{host_id}", headers=headers)
    assert deleted.status_code == 204


def test_finding_rejects_invalid_host():
    headers = authenticate()
    resp = client.post(
        "/findings",
        json={"host_id": "missing", "severity": "high", "description": "no host"},
        headers=headers,
    )
    assert resp.status_code == 400


def test_attack_path_validation():
    headers = authenticate()
    h1 = create_host(headers)
    h2_payload = {
        "hostname": "app-01",
        "ip_address": "10.0.0.4",
        "operating_system": "Debian",
        "criticality": "medium",
    }
    h2 = client.post("/hosts", json=h2_payload, headers=headers).json()

    valid_path = {
        "name": "Pivot from DB",
        "narrative": "SQLi pivot",
        "steps": [
            {"from_host": h1["id"], "to_host": h2["id"], "technique": "ssh-tunnel"}
        ],
        "likelihood": "high",
    }
    created = client.post("/attack-paths", json=valid_path, headers=headers)
    assert created.status_code == 200
    assert created.json()["name"] == "Pivot from DB"

    invalid_path = {
        "name": "Bad path",
        "narrative": "points to nowhere",
        "steps": [{"from_host": "ghost", "to_host": h2["id"], "technique": "rdp"}],
        "likelihood": "medium",
    }
    bad_resp = client.post("/attack-paths", json=invalid_path, headers=headers)
    assert bad_resp.status_code == 400


def test_lateral_movement_analysis():
    headers = authenticate()
    h1 = create_host(headers)
    h2 = create_host(headers)

    path = {
        "name": "Move",
        "narrative": "lateral",
        "steps": [{"from_host": h1["id"], "to_host": h2["id"], "technique": "psexec"}],
        "likelihood": "medium",
    }
    client.post("/attack-paths", json=path, headers=headers)
    analysis = client.get("/analysis/lateral-movement", headers=headers)
    assert analysis.status_code == 200
    assert h2["id"] in analysis.json()["reachable_hosts"]


def test_rejects_missing_token():
    resp = client.get("/hosts")
    assert resp.status_code == 401
