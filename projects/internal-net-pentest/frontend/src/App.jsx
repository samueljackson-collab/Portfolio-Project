import React, { useEffect, useMemo, useState } from 'react';
import {
  login,
  fetchHosts,
  createHost,
  createFinding,
  fetchAttackPaths,
  createAttackPath,
  fetchLateralMovement,
} from './api';
import HostList from './components/HostList';
import FindingForm from './components/FindingForm';
import AttackPathForm from './components/AttackPathForm';
import AttackPathList from './components/AttackPathList';
import Visualization from './components/Visualization';

export default function App() {
  const [token, setToken] = useState('');
  const [username, setUsername] = useState('operator');
  const [password, setPassword] = useState('');
  const [hosts, setHosts] = useState([]);
  const [attackPaths, setAttackPaths] = useState([]);
  const [analysis, setAnalysis] = useState(null);
  const authenticated = useMemo(() => Boolean(token), [token]);

  useEffect(() => {
    if (!authenticated) return;
    refreshHosts();
    refreshPaths();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [authenticated]);

  async function refreshHosts() {
    const data = await fetchHosts(token);
    setHosts(data);
  }

  async function refreshPaths() {
    const data = await fetchAttackPaths(token);
    setAttackPaths(data);
    const lateral = await fetchLateralMovement(token);
    setAnalysis(lateral);
  }

  async function handleLogin(event) {
    event.preventDefault();
    const result = await login(username, password);
    setToken(result.access_token);
  }

  async function handleHostCreate(payload) {
    await createHost(token, payload);
    refreshHosts();
  }

  async function handleFindingCreate(payload) {
    await createFinding(token, payload);
  }

  async function handleAttackPathCreate(payload) {
    await createAttackPath(token, payload);
    refreshPaths();
  }

  return (
    <div style={{ fontFamily: 'sans-serif', padding: '1rem', background: '#0f172a', color: '#e2e8f0', minHeight: '100vh' }}>
      <h1>Internal Network Pentest</h1>
      <p style={{ color: '#94a3b8' }}>Model hosts, findings, and attack paths with quick validation helpers.</p>

      {!authenticated ? (
        <form onSubmit={handleLogin} style={{ marginBottom: '1rem', background: '#1e293b', padding: '1rem', borderRadius: '8px' }}>
          <h2>Authenticate</h2>
          <label>
            Username
            <input value={username} onChange={(e) => setUsername(e.target.value)} />
          </label>
          <label style={{ marginLeft: '0.5rem' }}>
            Password
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
          </label>
          <button type="submit" style={{ marginLeft: '0.5rem' }}>Get Token</button>
        </form>
      ) : (
        <div style={{ marginBottom: '1rem', background: '#1e293b', padding: '0.75rem', borderRadius: '8px' }}>
          <strong>Authenticated</strong> as {username}
          <button style={{ marginLeft: '1rem' }} onClick={() => setToken('')}>
            Log out
          </button>
        </div>
      )}

      {authenticated && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
          <HostList hosts={hosts} onCreate={handleHostCreate} />
          <FindingForm hosts={hosts} onCreate={handleFindingCreate} />
          <AttackPathForm hosts={hosts} onCreate={handleAttackPathCreate} />
          <AttackPathList attackPaths={attackPaths} />
        </div>
      )}

      {analysis && authenticated && (
        <Visualization attackPaths={attackPaths} lateral={analysis} />
      )}
    </div>
  );
}
