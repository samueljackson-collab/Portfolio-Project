import { fireEvent, render, screen } from '@testing-library/react';
import { vi } from 'vitest';
import '@testing-library/jest-dom';
import AttackPathForm from '../components/AttackPathForm';

test('builds payload from selected hosts', async () => {
  const hosts = [
    { id: 'h1', hostname: 'db-01' },
    { id: 'h2', hostname: 'app-01' },
  ];
  const onCreate = vi.fn();
  render(<AttackPathForm hosts={hosts} onCreate={onCreate} />);

  fireEvent.change(screen.getByPlaceholderText(/Path name/i), { target: { value: 'Pivot' } });
  fireEvent.change(screen.getByPlaceholderText(/Narrative/i), { target: { value: 'move laterally' } });
  fireEvent.change(screen.getByDisplayValue(''), { target: { value: 'h1' } });
  fireEvent.change(screen.getAllByDisplayValue('')[1], { target: { value: 'h2' } });
  fireEvent.change(screen.getByPlaceholderText(/Technique/i), { target: { value: 'rdp' } });
  fireEvent.submit(screen.getByRole('button', { name: /create path/i }));

  expect(onCreate).toHaveBeenCalledWith({
    name: 'Pivot',
    narrative: 'move laterally',
    likelihood: 'medium',
    steps: [{ from_host: 'h1', to_host: 'h2', technique: 'rdp' }],
  });
});
