terraform {
  required_version = ">= 1.6.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.40"
    }
  }
}

provider "aws" {
  region = var.region
}

resource "aws_vpc" "pentest" {
  cidr_block           = "10.50.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true
  tags = { Name = "internal-net-pentest" }
}

resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.pentest.id
  cidr_block              = "10.50.1.0/24"
  map_public_ip_on_launch = true
  availability_zone       = "${var.region}a"
  tags = { Name = "internal-net-pentest-public" }
}

resource "aws_security_group" "api" {
  name        = "internal-net-pentest-api"
  description = "Allow app traffic"
  vpc_id      = aws_vpc.pentest.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_db_instance" "findings" {
  allocated_storage    = 20
  engine               = "postgres"
  engine_version       = "15"
  instance_class       = "db.t3.micro"
  username             = var.db_username
  password             = var.db_password
  skip_final_snapshot  = true
  publicly_accessible  = false
  vpc_security_group_ids = [aws_security_group.api.id]
  db_subnet_group_name = aws_db_subnet_group.pentest.name
}

resource "aws_db_subnet_group" "pentest" {
  name       = "pentest-db-subnets"
  subnet_ids = [aws_subnet.public.id]
}

resource "aws_launch_template" "ecs_nodes" {
  name_prefix   = "pentest-ecs-"
  image_id      = data.aws_ami.ecs_ami.id
  instance_type = "t3.small"
  user_data     = base64encode("#!/bin/bash\necho ECS_CLUSTER=${aws_ecs_cluster.pentest.name} >> /etc/ecs/ecs.config")
  vpc_security_group_ids = [aws_security_group.api.id]
}

data "aws_ami" "ecs_ami" {
  owners      = ["amazon"]
  most_recent = true
  filters {
    name   = "name"
    values = ["amzn2-ami-ecs-hvm-*-x86_64-ebs"]
  }
}

resource "aws_ecs_cluster" "pentest" {
  name = "internal-net-pentest"
}

resource "aws_ecs_capacity_provider" "ec2" {
  name = "pentest-ec2"

  auto_scaling_group_provider {
    auto_scaling_group_arn         = aws_autoscaling_group.ecs.arn
    managed_termination_protection = "DISABLED"
  }
}

resource "aws_autoscaling_group" "ecs" {
  desired_capacity = 1
  max_size         = 2
  min_size         = 1
  vpc_zone_identifier = [aws_subnet.public.id]
  launch_template {
    id      = aws_launch_template.ecs_nodes.id
    version = "$Latest"
  }
}

resource "aws_ecs_task_definition" "api" {
  family                   = "internal-net-pentest-api"
  network_mode             = "awsvpc"
  requires_compatibilities = ["EC2"]
  cpu                      = "256"
  memory                   = "512"

  container_definitions = jsonencode([
    {
      name      = "api",
      image     = var.api_container_image,
      essential = true,
      portMappings = [{ containerPort = 8000, hostPort = 8000 }],
      # Remove DATABASE_URL from environment, inject secrets instead
      secrets = [
        {
          name      = "DB_USERNAME",
          valueFrom = aws_secretsmanager_secret.db_credentials.arn
        },
        {
          name      = "DB_PASSWORD",
          valueFrom = aws_secretsmanager_secret.db_credentials.arn
        }
      ]
      # Optionally, you can still pass non-sensitive env vars here
    }
  ])
}

resource "aws_ecs_service" "api" {
  name            = "internal-net-pentest"
  cluster         = aws_ecs_cluster.pentest.id
  task_definition = aws_ecs_task_definition.api.arn
  desired_count   = 1
  launch_type     = "EC2"

  network_configuration {
    subnets         = [aws_subnet.public.id]
    security_groups = [aws_security_group.api.id]
  }

  capacity_provider_strategy {
    capacity_provider = aws_ecs_capacity_provider.ec2.name
    weight            = 1
  }
}

resource "aws_instance" "jumpbox" {
  ami                    = data.aws_ami.ecs_ami.id
  instance_type          = "t3.micro"
  subnet_id              = aws_subnet.public.id
  vpc_security_group_ids = [aws_security_group.api.id]
  tags = { Name = "pentest-jumpbox" }
}

variable "region" {
  description = "AWS region"
  type        = string
  default     = "us-east-1"
}

variable "api_container_image" {
  description = <<-EOT
    Container image for the API service. Must use immutable digest reference (@sha256:...) 
    instead of mutable tags (:latest) to prevent tag mutation attacks.
    
    To get the digest:
      docker pull example.com/internal-net-pentest-api:v1.0.0
      docker inspect --format='{{index .RepoDigests 0}}' example.com/internal-net-pentest-api:v1.0.0
    
    Best practices:
    - Always pin to specific SHA256 digest
    - Verify image signatures in CI/CD pipeline (e.g., using cosign or notary)
    - Use a container registry with access controls and audit logging
    - Regularly scan images for vulnerabilities
    
    NOTE: The default value is a placeholder. Replace with actual image digest before deployment.
  EOT
  type        = string
  default     = "example.com/internal-net-pentest-api@sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
}

variable "db_username" {
  description = "Database username"
  type        = string
}

variable "db_password" {
  description = "Database password"
  type        = string
  sensitive   = true
}
