# Internal Net Pentest Lab - Terraform Infrastructure

This directory contains the Terraform configuration for deploying the internal network penetration testing lab environment.

## Container Image Security

### Image Pinning
The ECS task definition uses a container image pinned to an immutable SHA256 digest instead of a mutable tag (e.g., `latest`). This prevents supply chain attacks where an attacker could compromise a registry and push a malicious image with the same tag.

**Current image reference format:**
```
example.com/internal-net-pentest-api@sha256:<digest>
```

> **Note:** The digest in `main.tf` is currently a placeholder. Replace it with the actual SHA256 digest from your container registry before deployment.

### Updating the Image Digest

When deploying a new version of the API container:

1. Build and push the new image to your container registry
2. Retrieve the image digest from the registry:
   ```bash
   docker inspect --format='{{index .RepoDigests 0}}' example.com/internal-net-pentest-api:latest
   ```
3. Update the `image` field in `main.tf` (line ~121) with the new digest
4. Optionally verify the image signature/attestation before deployment
5. Run `terraform plan` and `terraform apply` to deploy the update

### Build Pipeline Verification

Your CI/CD pipeline should include:
- Image scanning for vulnerabilities (e.g., Trivy, Snyk)
- Image signing (e.g., Docker Content Trust, Cosign)
- Attestation verification before deployment
- Automated digest updates in this Terraform configuration

## Deployment

```bash
terraform init
terraform plan
terraform apply
```

## Variables

- `region` - AWS region (default: us-east-1)
- `db_username` - Database username
- `db_password` - Database password (sensitive)
