# Wiki.js - Complete Production Docker Compose Configuration
# ===========================================================
# Version: 2.5.300 (Latest stable release)
# Platform: Ubuntu 22.04 LTS VM (VM ID: 100)
# Resources: 4 vCPU, 8GB RAM, 50GB Disk
# Network: 192.168.40.20/24 (VLAN 40 - Lab Network)
# External Access: https://wiki.homelab.local, https://wiki.example.com
#
# Wiki.js is a modern, powerful wiki application built on Node.js, Git, and PostgreSQL.
# This deployment provides:
# - PostgreSQL database backend (running on separate VM 192.168.40.23)
# - Persistent volume for uploads and content
# - Environment-based configuration (no secrets in compose file)
# - Health checks for container monitoring
# - Resource limits to prevent runaway processes
# - Reverse proxy integration (Nginx Proxy Manager)
#
# Why Wiki.js vs. Alternatives?
# ------------------------------
# Compared to MediaWiki:
# - Modern UI/UX (markdown editor, WYSIWYG mode)
# - Easier installation (single container vs. LAMP stack)
# - Better search (built-in full-text search, no ElasticSearch needed)
# - Git-based versioning (every edit is a git commit)
#
# Compared to Notion/Confluence:
# - Self-hosted (complete data ownership)
# - No recurring costs ($10/user/month for Confluence saved)
# - Offline access (not dependent on cloud availability)
# - Customizable (open-source, can modify code)
#
# Use Cases in Homelab:
# ---------------------
# 1. Technical Documentation:
#    - Homelab architecture and network diagrams
#    - Service runbooks and troubleshooting guides
#    - Configuration backups (Nginx configs, firewall rules)
#    - Change log (what changed, when, why)
#
# 2. Personal Knowledge Base:
#    - Project notes and ideas
#    - Meeting notes and retrospectives
#    - Learning resources (courses, tutorials, cheat sheets)
#    - Code snippets and command references
#
# 3. Team Collaboration (if sharing access):
#    - Shared documentation for family/roommates
#    - Guest Wi-Fi passwords and network info
#    - Home automation setup and usage guides
#
# Prerequisites:
# ==============
# 1. PostgreSQL database on 192.168.40.23:
#    CREATE DATABASE wikijs;
#    CREATE USER wikijs WITH PASSWORD 'from_env_file';
#    GRANT ALL PRIVILEGES ON DATABASE wikijs TO wikijs;
#
# 2. Directory structure:
#    mkdir -p /opt/wikijs/data
#    mkdir -p /opt/wikijs/uploads
#    chown -R 1000:1000 /opt/wikijs/
#
# 3. Environment variables in .env file:
#    WIKIJS_DB_PASSWORD=<strong_password>
#    WIKIJS_SESSION_SECRET=<random_64_char_hex>
#
# Deployment:
# ===========
#   docker-compose up -d
#
# Initial Setup:
# ==============
# 1. Access http://192.168.40.20:3000
# 2. Follow setup wizard:
#    - Admin email
#    - Admin password (strong password, 12+ characters)
#    - Site URL: https://wiki.homelab.local
# 3. Configure storage target (git repository optional)
# 4. Configure authentication (local, LDAP, OAuth)
# 5. Set up reverse proxy in Nginx Proxy Manager
#
# Last Updated: November 6, 2025
# ===========================================================

version: '3.9'

services:
  wiki:
    image: ghcr.io/requarks/wiki:2.5.300
    container_name: wikijs
    hostname: wiki

    # Run as unprivileged user for security
    # Wiki.js container runs as UID 1000 by default
    user: "1000:1000"

    restart: unless-stopped

    # Resource limits based on observed usage:
    # - Idle: 0.1 CPU, 200MB RAM
    # - Normal browsing: 0.3 CPU, 400MB RAM
    # - Search indexing: 1.5 CPU, 1GB RAM (background job)
    # - Large file upload: 1 CPU, 800MB RAM
    # Configured for typical homelab with <100 pages
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    environment:
      # Database connection (PostgreSQL on separate VM)
      # Separate database VM provides:
      # - Resource isolation (DB doesn't compete with app for RAM)
      # - Easier backups (backup DB once for all services)
      # - Scalability (can scale app and DB independently)
      DB_TYPE: postgres
      DB_HOST: 192.168.40.23
      DB_PORT: 5432
      DB_NAME: wikijs
      DB_USER: wikijs
      DB_PASS: ${WIKIJS_DB_PASSWORD}

      # Database connection pool settings
      # Increase if experiencing "too many connections" errors
      # Default: min=2, max=10 (suitable for <50 concurrent users)
      DB_POOL_MIN: 2
      DB_POOL_MAX: 10

      # SSL mode for PostgreSQL connection
      # 'disable' is OK for internal network (VM-to-VM traffic)
      # Use 'require' if database is on external network or internet
      DB_SSL: "false"

      # Public URL for the wiki
      # Used for:
      # - Email notifications (password reset links)
      # - OAuth callbacks (Google/GitHub login)
      # - Sitemap generation (SEO)
      # - API endpoints
      # Change to your actual domain when using external access
      WIKI_PUBLIC_URL: https://wiki.homelab.local

      # Session configuration
      # Session secret signs session cookies (prevents tampering)
      # CRITICAL: Must be random 64-character hex string
      # Generate with: openssl rand -hex 32
      SESSION_SECRET: ${WIKIJS_SESSION_SECRET}

      # Logging configuration
      # 'info' level is recommended for production
      # Use 'debug' when troubleshooting issues
      # Logs are captured by Docker and shipped to Loki
      LOG_LEVEL: info
      LOG_FORMAT: json

      # Timezone for timestamps
      TZ: America/Los_Angeles

      # Feature flags
      # Enable automatic page compilation (faster page loads)
      AUTO_PAGE_COMPILATION: "true"

      # Optional: External Git repository for backup/versioning
      # Wiki.js can push every edit to a Git repo (GitHub, GitLab, etc.)
      # This provides off-site backup and audit trail
      # Uncomment and configure if using:
      # GIT_REPO_URL: https://github.com/username/wiki-backup.git
      # GIT_REPO_BRANCH: main
      # GIT_REPO_USERNAME: github_username
      # GIT_REPO_PASSWORD: ${GITHUB_TOKEN}
      # GIT_SYNC_INTERVAL: 5m

      # Optional: S3-compatible storage for uploads
      # Use this if uploads exceed local disk space
      # Compatible with AWS S3, MinIO, Backblaze B2
      # STORAGE_TYPE: s3
      # STORAGE_S3_ENDPOINT: https://s3.us-west-2.amazonaws.com
      # STORAGE_S3_BUCKET: wikijs-uploads
      # STORAGE_S3_REGION: us-west-2
      # STORAGE_S3_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      # STORAGE_S3_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

    ports:
      # Wiki.js listens on port 3000
      # Nginx Proxy Manager forwards HTTPS traffic to this port
      # Internal network access only (no direct external access)
      - "3000:3000"

    volumes:
      # Application data (SQLite cache, temporary files, search index)
      # Size: ~100MB after initial setup, grows with page count
      - /opt/wikijs/data:/wiki/data

      # Uploaded files (images, documents, PDFs, attachments)
      # Size depends on usage: estimate 1-10MB per page with images
      # For large storage needs, consider S3-compatible backend
      - /opt/wikijs/uploads:/wiki/data/uploads

      # Optional: Custom configuration file
      # Allows advanced configuration beyond environment variables
      # See: https://docs.requarks.io/install/config
      # - ./config.yml:/wiki/config.yml:ro

      # Optional: Custom theme/CSS
      # - ./custom.css:/wiki/custom.css:ro

      # Timezone synchronization
      - /etc/localtime:/etc/localtime:ro

    # Health check monitors application availability
    # Wiki.js provides /healthz endpoint for this purpose
    # Prometheus uses this to detect service degradation
    # Docker will restart container if health checks fail
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Wiki.js startup takes 30-45 seconds

    networks:
      - wikijs_network

    labels:
      # Prometheus scraping
      # Wiki.js doesn't natively expose Prometheus metrics
      # Monitor via Node Exporter on host or create custom exporter
      - "prometheus.io/scrape=false"
      - "com.example.service=wikijs"
      - "com.example.description=Wiki.js knowledge base"
      - "com.example.team=homelab"

      # Backup tags
      - "backup.enable=true"
      - "backup.schedule=daily"
      - "backup.retention=30d"

    # Logging configuration
    # Wiki.js can be verbose, especially with DEBUG log level
    # Rotate logs to prevent disk space issues
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service,team"

    # Security options
    # Prevent container from gaining new privileges
    security_opt:
      - no-new-privileges:true

    # Read-only root filesystem (commented out - Wiki.js needs /tmp write access)
    # read_only: true

# =================================================
# Named Volumes (alternative to bind mounts)
# =================================================
# Uncomment if you prefer named volumes over bind mounts
# Named volumes are managed by Docker and easier to backup with Docker commands
# Bind mounts (current config) are easier to browse with file explorer

# volumes:
#   wikijs_data:
#     driver: local
#     labels:
#       - "backup.enable=true"
#       - "backup.retention=30d"
#   wikijs_uploads:
#     driver: local
#     labels:
#       - "backup.enable=true"
#       - "backup.retention=90d"

# =================================================
# Networks
# =================================================
networks:
  wikijs_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    labels:
      - "com.example.description=Wiki.js application network"

# ===========================================================
# CONFIGURATION & OPERATIONAL NOTES
# ===========================================================
#
# Post-Installation Configuration:
# ---------------------------------
# After first login, configure the following in Wiki.js Admin area:
#
# 1. Authentication:
#    - Admin > Authentication > Add Strategy
#    - Options: Local (default), LDAP, Google OAuth, GitHub OAuth
#    - Recommended: Enable Google OAuth for external access
#
# 2. Storage:
#    - Admin > Storage > Add Storage Target
#    - Options: Git, S3, Azure Blob, DigitalOcean Spaces
#    - Recommended: Git (automatic backup to GitHub/GitLab)
#
# 3. Search Engine:
#    - Admin > Search Engine > Select Engine
#    - Default: Database (PostgreSQL full-text search)
#    - For large wikis (>1000 pages): Consider Elasticsearch/Algolia
#
# 4. Rendering:
#    - Admin > Rendering > Configure Markdown Options
#    - Enable: Tables, Task Lists, Code Highlighting
#    - Syntax highlighting theme: GitHub Dark / Monokai
#
# 5. Editor:
#    - Admin > Editor > Set Default Editor
#    - Options: Markdown (recommended), Visual Editor, Code
#
# 6. Theme:
#    - Admin > Theme > Select Theme
#    - Default theme is modern and responsive
#    - Can customize with CSS injections
#
# Backup Strategy:
# ----------------
# Three-layer backup approach:
#
# 1. Database Backup (PostgreSQL VM):
#    - Automated daily dump: pg_dump wikijs > wikijs-YYYYMMDD.sql
#    - Retention: 7 daily, 4 weekly, 3 monthly
#    - Location: /var/backups/postgresql/
#
# 2. Volume Backup (Docker volumes):
#    - Automated daily backup of /opt/wikijs/
#    - Script: tar -czf wikijs-data-$(date +%Y%m%d).tar.gz /opt/wikijs/
#    - Retention: 30 days
#    - Location: /mnt/nfs-backups/wikijs/
#
# 3. VM Backup (Proxmox Backup Server):
#    - Nightly full VM backup at 02:00 AM
#    - Includes: OS, Docker, volumes, configurations
#    - Retention: 7 daily, 4 weekly, 3 monthly
#
# 4. Optional: Git Sync (if enabled):
#    - Every page edit creates git commit
#    - Automatically pushed to remote repository
#    - Provides off-site backup and version history
#    - Can restore entire wiki from git clone
#
# Recovery Point Objective (RPO): 24 hours (daily backups)
# Recovery Time Objective (RTO): 30 minutes (VM restore + container start)
#
# Disaster Recovery Procedure:
# -----------------------------
# Scenario: Complete VM failure
# 1. Deploy fresh Ubuntu 22.04 VM (10 min)
# 2. Install Docker: apt install docker.io docker-compose (2 min)
# 3. Restore /opt/wikijs/ from backup: tar -xzf wikijs-data-YYYYMMDD.tar.gz (3 min)
# 4. Deploy container: docker-compose up -d (2 min)
# 5. Verify database connectivity and test wiki access (3 min)
# Total RTO: 20 minutes
#
# Scenario: Database corruption
# 1. Stop Wiki.js container: docker-compose down
# 2. Restore PostgreSQL backup: psql -h 192.168.40.23 < wikijs-YYYYMMDD.sql
# 3. Start Wiki.js: docker-compose up -d
# 4. Verify pages and uploads are intact
# Total RTO: 10 minutes
#
# Scenario: Complete data center loss (if Git sync enabled)
# 1. Deploy new infrastructure (Proxmox, VMs, Docker)
# 2. Clone git repository: git clone https://github.com/user/wiki-backup.git
# 3. Import pages: Admin > Storage > Git > Import from Remote
# 4. Wait for import (depends on wiki size, ~10min for 500 pages)
# Total RTO: 1-2 hours
#
# Performance Tuning:
# -------------------
# For wikis with >500 pages or >50 concurrent users:
#
# 1. Database Optimization:
#    - Increase connection pool: DB_POOL_MAX: 20
#    - Add PostgreSQL indexes (Wiki.js creates automatically)
#    - Enable query caching in PostgreSQL
#
# 2. Application Optimization:
#    - Enable Redis for session storage (reduces DB load)
#    - Enable asset caching in Nginx (static files served faster)
#    - Increase container CPU/RAM limits
#
# 3. Search Optimization:
#    - Switch from PostgreSQL to Elasticsearch
#    - Reduces database load, faster search results
#    - Requires additional container: elasticsearch:8.x
#
# 4. Upload Optimization:
#    - Switch to S3-compatible storage (MinIO, Backblaze B2)
#    - Offloads file serving from application
#    - Allows CDN integration for faster global access
#
# Monitoring & Alerting:
# ----------------------
# Key metrics to monitor:
#
# Prometheus Queries:
# - Container uptime: up{job="wikijs"}
# - Memory usage: container_memory_usage_bytes{name="wikijs"}
# - CPU usage: rate(container_cpu_usage_seconds_total{name="wikijs"}[5m])
# - Request rate: rate(nginx_http_requests_total{upstream="wikijs"}[5m])
# - Response time: nginx_http_request_duration_seconds{upstream="wikijs"}
#
# Grafana Dashboard:
# - "Application Overview" (generic Docker container metrics)
# - Custom dashboard with Nginx metrics (if using Nginx Prometheus exporter)
#
# Alerts:
# - Service down >5 minutes ’ Critical (Slack/email)
# - Memory usage >80% ’ Warning
# - Disk usage >90% ’ Critical (expand storage)
# - Database connection failures ’ Critical
#
# Troubleshooting:
# ----------------
# Issue: Container won't start
# Solutions:
#   - Check database connectivity: telnet 192.168.40.23 5432
#   - Verify environment variables: docker-compose config
#   - Check logs: docker-compose logs wiki
#   - Verify file permissions: ls -la /opt/wikijs/
#
# Issue: Cannot login (forgot admin password)
# Solutions:
#   - Access PostgreSQL: psql -h 192.168.40.23 -U wikijs -d wikijs
#   - Reset admin password (manual SQL):
#     UPDATE users SET password = '$2a$12$YOUR_BCRYPT_HASH' WHERE email = 'admin@example.com';
#   - Alternative: Create new admin via SQL, delete old account
#
# Issue: Uploads failing
# Solutions:
#   - Check disk space: df -h /opt/wikijs/uploads
#   - Verify permissions: ls -la /opt/wikijs/uploads
#   - Check max upload size: Admin > Rendering > Max Upload Size
#   - Review Nginx limits: client_max_body_size in Nginx config
#
# Issue: Search not working
# Solutions:
#   - Rebuild search index: Admin > Search > Rebuild Index
#   - Check PostgreSQL: SELECT * FROM pageSearch LIMIT 10;
#   - Switch search engine: Admin > Search > PostgreSQL / Elasticsearch
#
# Issue: Pages loading slowly
# Solutions:
#   - Check database performance: pg_stat_statements in PostgreSQL
#   - Enable caching: Admin > Caching > Enable Redis
#   - Optimize images: Compress large uploaded images
#   - Add Nginx caching: proxy_cache in Nginx config
#
# Security Hardening:
# -------------------
# Current security measures:
# - [x] Database credentials in .env (not in compose file)
# - [x] Non-root user (UID 1000)
# - [x] Resource limits (prevent DoS)
# - [x] Health checks (detect compromised containers)
# - [x] Internal network only (no direct external access)
# - [x] Reverse proxy with HTTPS (SSL termination at Nginx)
#
# Future security improvements:
# - [ ] Enable two-factor authentication (2FA)
# - [ ] Implement rate limiting (prevent brute force)
# - [ ] Enable audit logging (track user actions)
# - [ ] Set up fail2ban (IP ban after failed logins)
# - [ ] Enable CSP headers (prevent XSS attacks)
# - [ ] Regular updates (check for new releases monthly)
#
# Update Procedure:
# -----------------
# Wiki.js releases quarterly (check https://github.com/Requarks/wiki/releases)
#
# Update steps:
# 1. Backup current state: docker-compose down && tar -czf wiki-backup.tar.gz /opt/wikijs
# 2. Review release notes: Check for breaking changes
# 3. Update docker-compose.yml: Change image tag to new version
# 4. Pull new image: docker-compose pull
# 5. Recreate container: docker-compose up -d
# 6. Monitor logs: docker-compose logs -f wiki
# 7. Verify functionality: Test login, page editing, search
# 8. If issues: Rollback (restore backup, change tag to old version)
#
# Common Operations:
# ------------------
# View logs: docker-compose logs -f wiki
# Restart: docker-compose restart wiki
# Stop: docker-compose down
# Start: docker-compose up -d
# Update: docker-compose pull && docker-compose up -d
# Shell access: docker exec -it wikijs sh
# Backup volumes: tar -czf wiki-backup.tar.gz /opt/wikijs
# Restore volumes: tar -xzf wiki-backup.tar.gz -C /
# Rebuild index: Admin > Utilities > Rebuild Search Index
#
# Integration Examples:
# ---------------------
# 1. Embed Wiki in Other Apps:
#    - Use iframe: <iframe src="https://wiki.homelab.local/page"></iframe>
#    - Use Wiki.js API to fetch content programmatically
#
# 2. Single Sign-On (SSO):
#    - Configure OAuth2 with Google/GitHub
#    - Users login once, access wiki without separate password
#
# 3. Automation via API:
#    - Create pages programmatically (infrastructure as code documentation)
#    - Update runbooks with cronjobs (auto-generate from configs)
#    - Export pages to PDF (scheduled reports)
#
# 4. Webhooks:
#    - Trigger actions on page create/update
#    - Send Slack notifications when important pages change
#    - Sync to external systems (Notion, Confluence)
#
# ===========================================================
