# Prometheus Configuration - Production Homelab Setup
# ===================================================
# Last Updated: November 6, 2025
# Version: 2.48

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s
  
  external_labels:
    environment: 'homelab'
    cluster: 'primary'

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'
      timeout: 10s
      api_version: v2

rule_files:
  - 'alerts/*.yml'
  - 'recording_rules/*.yml'

scrape_configs:
  # Self-monitoring
  - job_name: 'prometheus'
    scrape_interval: 30s
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          tier: 'monitoring'
          criticality: 'high'

  # Node Exporter - System metrics
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['192.168.40.20:9100']
        labels:
          instance: 'wikijs-vm'
          service: 'wiki.js'
          tier: 'application'
          criticality: 'medium'
      
      - targets: ['192.168.40.21:9100']
        labels:
          instance: 'homeassistant-vm'
          service: 'home-assistant'
          tier: 'application'
          criticality: 'high'
      
      - targets: ['192.168.40.22:9100']
        labels:
          instance: 'immich-vm'
          service: 'immich'
          tier: 'application'
          criticality: 'medium'
      
      - targets: ['192.168.40.23:9100']
        labels:
          instance: 'postgres-vm'
          service: 'postgresql'
          tier: 'database'
          criticality: 'critical'
      
      - targets: ['192.168.40.25:9100']
        labels:
          instance: 'nginx-vm'
          service: 'nginx-proxy-manager'
          tier: 'infrastructure'
          criticality: 'critical'

  # PostgreSQL Exporter
  - job_name: 'postgres_exporter'
    scrape_interval: 30s
    static_configs:
      - targets: ['192.168.40.23:9187']
        labels:
          instance: 'postgres-vm'
          service: 'postgresql'
          tier: 'database'
          criticality: 'critical'

  # Blackbox Exporter - HTTP monitoring
  - job_name: 'blackbox_http'
    scrape_interval: 30s
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://wiki.homelab.local
          - https://homeassistant.homelab.local
          - https://immich.homelab.local
          - https://grafana.homelab.local
        labels:
          check_type: 'http'
          tier: 'application'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: '192.168.40.30:9115'

  # cAdvisor - Container metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets:
          - '192.168.40.20:8080'
          - '192.168.40.22:8080'
          - '192.168.40.23:8080'
          - '192.168.40.30:8080'
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'container_(cpu|memory|network|fs).*'
        action: keep
