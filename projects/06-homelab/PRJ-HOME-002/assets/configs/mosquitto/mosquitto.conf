# ==============================================================================
# Mosquitto MQTT Broker Configuration
# ==============================================================================
#
# SECURITY MODEL:
# ---------------
# - Authentication required (no anonymous access)
# - Password-based authentication using hashed password file
# - Optional: ACL file for fine-grained topic permissions
#
# LISTENERS:
# ----------
# - Port 1883: MQTT over TCP (unencrypted, local network only)
# - Port 9001: MQTT over WebSockets (for web-based clients)
# - Port 8883: MQTT over TLS/SSL (commented out, enable for production)
#
# PERSISTENCE:
# ------------
# - Retained messages persisted to disk (survives broker restarts)
# - Subscriptions persisted to disk (clients reconnect automatically)
# - QoS 1 and 2 messages stored for offline clients
#
# DEPLOYMENT NOTES:
# -----------------
# - Create password file: mosquitto_passwd -c passwd <username>
# - Restart broker after config changes
# - Monitor logs: tail -f /mosquitto/log/mosquitto.log
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Persistence Configuration
# ------------------------------------------------------------------------------

# Enable message persistence (retained messages, subscriptions)
persistence true

# Persistence location (mapped to Docker volume)
persistence_location /mosquitto/data/

# Save persistence file every 1800 seconds (30 minutes)
# Or after 100 subscription changes
autosave_interval 1800
autosave_on_changes true

# ------------------------------------------------------------------------------
# Logging Configuration
# ------------------------------------------------------------------------------

# Log to file (useful for troubleshooting)
log_dest file /mosquitto/log/mosquitto.log

# Also log to stdout (visible in docker logs)
log_dest stdout

# Log types to include
# Options: error, warning, notice, information, subscribe, unsubscribe, websockets, none, all
log_type error
log_type warning
log_type notice
log_type information

# Include timestamps in logs
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# ------------------------------------------------------------------------------
# Authentication Configuration
# ------------------------------------------------------------------------------

# Disable anonymous access (require username/password)
allow_anonymous false

# Password file location (created with mosquitto_passwd command)
# Generate with: docker run --rm -v $(pwd)/mosquitto:/mosquitto eclipse-mosquitto:2.0 \
#                mosquitto_passwd -c /mosquitto/passwd <username>
password_file /mosquitto/config/passwd

# Optional: Access Control List (ACL) for topic-level permissions
# Uncomment and create ACL file if you need fine-grained topic access control
# acl_file /mosquitto/config/acl

# ------------------------------------------------------------------------------
# Network Listeners
# ------------------------------------------------------------------------------

# Listener 1: MQTT over TCP (port 1883)
# Used by: Home Assistant, ESP32 devices, Zigbee2MQTT, Tasmota
listener 1883
protocol mqtt

# Maximum connections per listener (adjust based on device count)
max_connections -1

# Listener 2: MQTT over WebSockets (port 9001)
# Used by: Web-based MQTT clients, browser applications
listener 9001
protocol websockets

# Optional: MQTT over TLS/SSL (port 8883)
# Uncomment and configure certificates for encrypted MQTT
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# tls_version tlsv1.2

# ------------------------------------------------------------------------------
# Performance Tuning
# ------------------------------------------------------------------------------

# Maximum QoS level (0, 1, or 2)
# QoS 0: Fire and forget (fastest, no guarantees)
# QoS 1: At least once delivery (good balance)
# QoS 2: Exactly once delivery (slowest, highest reliability)
max_qos 1

# Maximum packet size (bytes)
# Increase for large payloads (e.g., camera snapshots)
message_size_limit 268435456  # 256MB

# Maximum queued messages per client (for offline clients)
# Adjust based on expected offline duration and message rate
max_queued_messages 1000
max_queued_bytes 10485760  # 10MB

# Client connection timeout (seconds)
# Disconnect clients that don't send data within this time
keepalive_interval 60

# ------------------------------------------------------------------------------
# Bridge Configuration (Optional)
# ------------------------------------------------------------------------------

# Bridge to another MQTT broker (e.g., cloud service)
# Uncomment and configure if you need to forward messages to another broker
# connection bridge-to-cloud
# address mqtt.example.com:1883
# topic # both 0
# bridge_protocol_version mqttv311
# remote_username cloud-user
# remote_password cloud-password

# ==============================================================================
# SECURITY HARDENING CHECKLIST
# ==============================================================================
#
# [ ] Enable TLS/SSL for external access (listener 8883)
# [ ] Create ACL file for topic-level permissions
# [ ] Rotate passwords annually
# [ ] Monitor failed authentication attempts (grep "refused" logs)
# [ ] Restrict port 1883 to local network only (firewall rules)
# [ ] Use strong passwords (20+ characters)
# [ ] Enable rate limiting for brute-force protection
# [ ] Regularly update Mosquitto to latest version
#
# ==============================================================================
# EXAMPLE ACL FILE (mosquitto/acl)
# ==============================================================================
#
# # Admin user (full access)
# user admin
# topic readwrite #
#
# # Home Assistant (read/write to all topics)
# user homeassistant
# topic readwrite #
#
# # Zigbee2MQTT (restricted to zigbee2mqtt topics)
# user zigbee2mqtt
# topic readwrite zigbee2mqtt/#
# topic read homeassistant/#
#
# # Tasmota devices (restricted to tasmota topics)
# user tasmota
# topic readwrite tasmota/#
# topic read cmnd/tasmota/#
# topic write stat/tasmota/#
# topic write tele/tasmota/#
#
# # ESP32 sensors (read-only access to config, write to sensor topics)
# user esp32-sensor
# topic read homeassistant/sensor/config/#
# topic write homeassistant/sensor/+/state
#
# ==============================================================================
# PASSWORD FILE GENERATION
# ==============================================================================
#
# # Create password file (first user)
# docker run --rm -v $(pwd)/mosquitto:/mosquitto eclipse-mosquitto:2.0 \
#   mosquitto_passwd -c /mosquitto/passwd homeassistant
#
# # Add additional users (don't use -c, it overwrites the file)
# docker run --rm -v $(pwd)/mosquitto:/mosquitto eclipse-mosquitto:2.0 \
#   mosquitto_passwd -b /mosquitto/passwd admin strongpassword123
#
# # Alternative: Use environment variables from .env
# docker run --rm -v $(pwd)/mosquitto:/mosquitto eclipse-mosquitto:2.0 \
#   sh -c "mosquitto_passwd -c -b /mosquitto/passwd ${MQTT_USERNAME} ${MQTT_PASSWORD}"
#
# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================
#
# # Test MQTT connection
# docker exec -it mosquitto mosquitto_sub -t '#' -u username -P password
#
# # Publish test message
# docker exec -it mosquitto mosquitto_pub -t 'test/topic' -m 'Hello MQTT' -u username -P password
#
# # Check broker status
# docker exec -it mosquitto mosquitto_sub -t '$SYS/#' -u username -P password
#
# # View active connections
# grep "New connection" /var/lib/docker/volumes/mosquitto-log/_data/mosquitto.log
#
# # Check authentication failures
# grep "refused" /var/lib/docker/volumes/mosquitto-log/_data/mosquitto.log
#
# ==============================================================================
