#cloud-config
# Cloud-Init Configuration for Proxmox VM Templates
# This file provides default configuration and security hardening
# for Ubuntu VMs created from templates
#
# Version: 1.0
# Last Updated: 2025-11-05
#
# Usage: This configuration is applied during VM first boot
# Customize per-VM via Proxmox Cloud-Init GUI or CLI

# System Information
hostname: ubuntu-vm
manage_etc_hosts: true
fqdn: ubuntu-vm.homelab.local
prefer_fqdn_over_hostname: true

# Timezone and Locale
timezone: America/New_York
locale: en_US.UTF-8

# Users Configuration
users:
  - name: ubuntu
    groups: [adm, audio, cdrom, dialout, dip, floppy, netdev, plugdev, sudo, video]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC... # Replace with your public key
    lock_passwd: false
    # Initial password (will be changed on first login)
    # Generate with: mkpasswd --method=SHA-512 --rounds=4096
    passwd: $6$rounds=4096$randomsalt$hashedpassword

# SSH Configuration
ssh_pwauth: false  # Disable password authentication
ssh_deletekeys: true  # Delete old host keys
ssh_genkeytypes: [rsa, ecdsa, ed25519]  # Generate new host keys

# Package Management
package_update: true
package_upgrade: true
package_reboot_if_required: false

# Packages to Install
packages:
  # System essentials
  - qemu-guest-agent
  - cloud-init
  - cloud-utils
  - cloud-initramfs-growroot
  
  # Security
  - fail2ban
  - ufw
  - unattended-upgrades
  - apt-listchanges
  
  # Monitoring and logging
  - htop
  - iotop
  - nethogs
  - sysstat
  - rsyslog
  
  # Network tools
  - net-tools
  - curl
  - wget
  - dnsutils
  - traceroute
  - tcpdump
  
  # System utilities
  - vim
  - nano
  - tmux
  - git
  - zip
  - unzip
  
  # Python
  - python3
  - python3-pip
  - python3-venv

# System Configuration
write_files:
  # Configure automatic security updates
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}ESMApps:${distro_codename}-apps-security";
          "${distro_id}ESM:${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::InstallOnShutdown "false";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
      Unattended-Upgrade::Automatic-Reboot-Time "03:00";
    permissions: '0644'
    owner: root:root
  
  # Enable automatic updates
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";
    permissions: '0644'
    owner: root:root
  
  # Fail2ban SSH jail configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      
      [sshd]
      enabled = true
      port = ssh
      logpath = /var/log/auth.log
      maxretry = 3
    permissions: '0644'
    owner: root:root
  
  # Sysctl security hardening
  - path: /etc/sysctl.d/99-security-hardening.conf
    content: |
      # IP Forwarding (disable if not a router)
      net.ipv4.ip_forward = 0
      
      # SYN cookies protection
      net.ipv4.tcp_syncookies = 1
      
      # Disable source packet routing
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      
      # Disable ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv4.conf.all.secure_redirects = 0
      net.ipv4.conf.default.secure_redirects = 0
      
      # Log martian packets
      net.ipv4.conf.all.log_martians = 1
      net.ipv4.conf.default.log_martians = 1
      
      # Ignore ICMP ping requests
      # net.ipv4.icmp_echo_ignore_all = 1
      
      # Disable IPv6 if not needed
      # net.ipv6.conf.all.disable_ipv6 = 1
      # net.ipv6.conf.default.disable_ipv6 = 1
    permissions: '0644'
    owner: root:root
  
  # MOTD (Message of the Day)
  - path: /etc/motd
    content: |
      ========================================
      Welcome to Ubuntu Server
      Managed by Proxmox with Cloud-Init
      ========================================
      
      System Information:
      - OS: Ubuntu 22.04 LTS
      - Kernel: $(uname -r)
      - QEMU Guest Agent: Enabled
      - Automatic Updates: Enabled
      - Security: Hardened
      
      Important Notes:
      - All actions are logged
      - Unauthorized access is prohibited
      - Contact: admin@homelab.local
      
      ========================================
    permissions: '0644'
    owner: root:root

# Networking (can be overridden by Proxmox Cloud-Init)
# This is a fallback configuration
network:
  version: 2
  ethernets:
    ens18:
      dhcp4: true
      dhcp6: false

# NTP Configuration
ntp:
  enabled: true
  servers:
    - 192.168.40.1  # pfSense/local NTP
    - pool.ntp.org
    - time.cloudflare.com

# DNS Configuration
manage_resolv_conf: true
resolv_conf:
  nameservers:
    - 192.168.40.35  # Pi-hole
    - 192.168.1.1    # pfSense
    - 1.1.1.1        # Cloudflare (fallback)
  searchdomains:
    - homelab.local
  domain: homelab.local

# Run Commands (executed in order)
runcmd:
  # Update package cache
  - apt-get update
  
  # Enable and start QEMU guest agent
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  
  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw --force enable
  
  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Configure sysctl settings
  - sysctl -p /etc/sysctl.d/99-security-hardening.conf
  
  # Disable unnecessary services
  - systemctl disable bluetooth.service || true
  - systemctl disable avahi-daemon.service || true
  
  # Set correct permissions on home directory
  - chmod 700 /home/ubuntu
  
  # Configure timezone
  - timedatectl set-timezone America/New_York
  
  # Sync time immediately
  - systemctl restart systemd-timesyncd
  
  # Clean up
  - apt-get autoremove -y
  - apt-get clean
  
  # Log completion
  - echo "Cloud-Init configuration completed at $(date)" >> /var/log/cloud-init-completion.log

# Growpart - Automatically expand root partition
growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false

# Resize filesystem
resize_rootfs: true

# Power State
# Options: poweroff, halt, reboot
# Set to false to keep running after cloud-init completes
power_state:
  mode: false
  message: Cloud-Init configuration complete
  timeout: 30
  condition: true

# Final Message
final_message: |
  ========================================
  Cloud-Init Setup Complete!
  ========================================
  System: $UPTIME
  Cloud-Init Version: $version
  Datasource: $datasource
  ========================================
  
  The system is now ready for use.
  
  Security Features Enabled:
  - SSH key-only authentication
  - UFW firewall configured
  - Fail2ban active
  - Automatic security updates
  - System hardening applied
  
  Next Steps:
  1. Verify SSH access with key
  2. Configure application-specific settings
  3. Set up monitoring
  4. Configure backups
  
  Documentation: /var/log/cloud-init.log
  ========================================

# Logging
output:
  all: '| tee -a /var/log/cloud-init-output.log'

# Preserve source repository
apt_preserve_sources_list: false

# Cloud-Init modules
cloud_init_modules:
  - migrator
  - seed_random
  - bootcmd
  - write-files
  - growpart
  - resizefs
  - disk_setup
  - mounts
  - set_hostname
  - update_hostname
  - update_etc_hosts
  - ca-certs
  - rsyslog
  - users-groups
  - ssh

cloud_config_modules:
  - emit_upstart
  - snap
  - ssh-import-id
  - locale
  - set-passwords
  - grub-dpkg
  - apt-pipelining
  - apt-configure
  - ubuntu-advantage
  - ntp
  - timezone
  - disable-ec2-metadata
  - runcmd
  - byobu

cloud_final_modules:
  - package-update-upgrade-install
  - fan
  - landscape
  - lxd
  - ubuntu-drivers
  - write-files-deferred
  - puppet
  - chef
  - mcollective
  - salt-minion
  - reset_rmc
  - refresh_rmc_and_interface
  - rightscale_userdata
  - scripts-vendor
  - scripts-per-once
  - scripts-per-boot
  - scripts-per-instance
  - scripts-user
  - ssh-authkey-fingerprints
  - keys-to-console
  - phone-home
  - final-message
  - power-state-change

# End of cloud-config
