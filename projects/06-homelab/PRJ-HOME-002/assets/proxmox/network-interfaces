# Proxmox VE Network Interfaces Configuration
# /etc/network/interfaces
# VLAN-aware bridges with bonding for redundancy
# Version: Proxmox VE 8.x
# Last Updated: 2025-11-05

# Loopback interface
auto lo
iface lo inet loopback

# Physical Network Interfaces
# Two physical interfaces for bonding (redundancy)

# Primary interface - eno1
# Connected to UniFi Switch port (VLAN trunk)
auto eno1
iface eno1 inet manual
	# No IP configuration (used in bond)

# Secondary interface - eno2  
# Connected to UniFi Switch port (VLAN trunk, backup)
auto eno2
iface eno2 inet manual
	# No IP configuration (used in bond)

# Bonded Interface (LACP/802.3ad)
# Active-backup or LACP bond for redundancy
# Mode 4 = 802.3ad (LACP) - requires switch support
# Mode 1 = active-backup - simpler, no switch config needed
auto bond0
iface bond0 inet manual
	# Bonding mode
	# Mode 1 (active-backup): Simple failover
	# Mode 4 (802.3ad): LACP aggregation
	bond-slaves eno1 eno2
	bond-mode 802.3ad
	bond-miimon 100
	bond-downdelay 200
	bond-updelay 200
	bond-lacp-rate slow
	bond-xmit-hash-policy layer3+4
	# Layer3+4 hashing for better load distribution

# Alternative: Simple active-backup bonding (no switch config needed)
# auto bond0
# iface bond0 inet manual
# 	bond-slaves eno1 eno2
# 	bond-mode active-backup
# 	bond-miimon 100
# 	bond-primary eno1

# VLAN-aware Linux Bridge
# Primary bridge for VM networking with VLAN support
auto vmbr0
iface vmbr0 inet static
	# Management IP address (VLAN 40 - Servers)
	address 192.168.40.10/24
	gateway 192.168.40.1
	# DNS servers
	dns-nameservers 192.168.40.35 192.168.1.1
	dns-search homelab.local
	# Bridge configuration
	bridge-ports bond0
	bridge-stp off
	bridge-fd 0
	bridge-vlan-aware yes
	bridge-vids 2-4094
	# Allow all VLANs (2-4094)
	# VMs can be assigned to specific VLANs via GUI or config

# Alternative: Non-VLAN-aware bridge (simpler, less flexible)
# auto vmbr0
# iface vmbr0 inet static
# 	address 192.168.40.10/24
# 	gateway 192.168.40.1
# 	bridge-ports bond0
# 	bridge-stp off
# 	bridge-fd 0

# Dedicated Ceph Cluster Network Bridge (Optional but recommended)
# Separate network for Ceph cluster communication
# Improves performance and security
# Requires additional NICs or VLAN segmentation
auto vmbr1
iface vmbr1 inet static
	# Ceph cluster network (private subnet)
	address 10.10.10.10/24
	# No gateway (cluster-only traffic)
	bridge-ports eno3
	bridge-stp off
	bridge-fd 0
	# Note: eno3 is a dedicated interface for Ceph
	# Can use VLAN on bond0 instead: bridge-ports bond0.100

# Alternative: Ceph on VLAN instead of dedicated interface
# auto vmbr1
# iface vmbr1 inet static
# 	address 10.10.10.10/24
# 	bridge-ports bond0.100
# 	bridge-stp off
# 	bridge-fd 0

# OVS Bridge (Optional - if using Open vSwitch)
# Provides advanced networking features
# Requires openvswitch packages installed
# auto vmbr0
# iface vmbr0 inet manual
# 	ovs_type OVSBridge
# 	ovs_ports bond0
# 	ovs_options vlan_mode=trunk tag=40

# Node-specific configurations
# Adjust IP addresses for each node

# Node 1 (proxmox-01): 192.168.40.10, Ceph: 10.10.10.10
# Node 2 (proxmox-02): 192.168.40.11, Ceph: 10.10.10.11  
# Node 3 (proxmox-03): 192.168.40.12, Ceph: 10.10.10.12

# VLAN Assignments for VMs
# Configure in VM settings or via CLI
# Example: vm-100-vlan-10.network

# VLAN 10 (Trusted)
# qm set 100 -net0 virtio,bridge=vmbr0,tag=10

# VLAN 20 (IoT)
# qm set 101 -net0 virtio,bridge=vmbr0,tag=20

# VLAN 30 (Guest)
# qm set 102 -net0 virtio,bridge=vmbr0,tag=30

# VLAN 40 (Servers) - Default, no tag needed
# qm set 103 -net0 virtio,bridge=vmbr0

# VLAN 50 (DMZ)
# qm set 104 -net0 virtio,bridge=vmbr0,tag=50

# Network Performance Tuning
# Applied via sysctl or /etc/sysctl.d/proxmox-network.conf

# Enable IP forwarding (required for routing)
# net.ipv4.ip_forward=1
# net.ipv6.conf.all.forwarding=1

# Increase network buffer sizes
# net.core.rmem_max=134217728
# net.core.wmem_max=134217728
# net.ipv4.tcp_rmem=4096 87380 67108864
# net.ipv4.tcp_wmem=4096 65536 67108864

# Enable TCP window scaling
# net.ipv4.tcp_window_scaling=1

# Increase connection tracking table size
# net.netfilter.nf_conntrack_max=1048576

# Jumbo frames (if supported by network infrastructure)
# Uncomment and set MTU to 9000 on all interfaces
# auto eno1
# iface eno1 inet manual
# 	mtu 9000

# Firewall Integration
# Proxmox firewall rules managed via GUI or /etc/pve/firewall/
# Enable per-VM firewall in VM options
# Enable datacenter firewall in datacenter options

# Migration Network (Optional)
# Separate network for live migration traffic
# Reduces impact on production traffic
# Can use VLAN or dedicated interface

# auto vmbr2
# iface vmbr2 inet static
# 	address 10.20.20.10/24
# 	bridge-ports bond0.200
# 	bridge-stp off
# 	bridge-fd 0
# Configure in /etc/pve/datacenter.cfg:
# migration: network=10.20.20.0/24

# Monitoring and Troubleshooting Commands
# ip addr show                    - Show all interfaces
# ip link show                    - Show link status
# brctl show                      - Show bridge information
# bridge vlan show                - Show VLAN configuration
# bond0: cat /proc/net/bonding/bond0  - Show bonding status
# ethtool eno1                    - Show interface details
# tcpdump -i vmbr0                - Capture traffic on bridge
# iperf3 -s                       - Test network performance

# Best Practices:
# 1. Use bonding for redundancy (even in homelab)
# 2. Enable VLAN awareness for flexibility
# 3. Separate Ceph traffic for performance
# 4. Use consistent naming across cluster
# 5. Document VLAN assignments
# 6. Monitor network performance
# 7. Regular testing of failover scenarios
# 8. Keep firmware updated on NICs

# Security Considerations:
# 1. Enable Proxmox firewall
# 2. Restrict management access to specific VLANs
# 3. Use VLANs for network segmentation
# 4. Monitor for unusual traffic patterns
# 5. Regular security updates
# 6. Disable unused interfaces
# 7. Use strong passwords for BMC/IPMI

# Maintenance:
# - Test bonding failover regularly
# - Monitor network errors: ip -s link
# - Check bridge MAC learning: bridge fdb show
# - Verify VLAN configuration after changes
# - Document any custom routing or firewall rules
