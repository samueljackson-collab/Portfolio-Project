# Immich Photo Service - Docker Compose Configuration
# Version: Latest stable
# Network: Application VLAN (192.168.30.x)
# Storage: TrueNAS NFS mount (tank/homelab/media)

version: "3.8"

services:
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    command: ['start.sh', 'immich']
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - .env
    depends_on:
      - redis
      - database
    restart: unless-stopped
    networks:
      - immich-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.rule=Host(`photos.homelab.local`)"
      - "traefik.http.routers.immich.entrypoints=websecure"
      - "traefik.http.routers.immich.tls=true"
      - "traefik.http.services.immich.loadbalancer.server.port=3001"

  immich-microservices:
    container_name: immich_microservices
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    command: ['start.sh', 'microservices']
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - .env
    depends_on:
      - redis
      - database
    restart: unless-stopped
    networks:
      - immich-network

  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - model-cache:/cache
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - immich-network

  redis:
    container_name: immich_redis
    image: redis:7.2-alpine
    restart: unless-stopped
    networks:
      - immich-network
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3

  database:
    container_name: immich_postgres
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    env_file:
      - .env
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_DATABASE_NAME}
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - immich-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE_NAME}"]
      interval: 30s
      timeout: 5s
      retries: 5

networks:
  immich-network:
    driver: bridge

volumes:
  pgdata:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.10.11,rw,nfsvers=4
      device: ":/mnt/tank/homelab/databases/immich"

  model-cache:
    driver: local

  redis-data:
    driver: local

# Environment variables (.env file example):
# IMMICH_VERSION=release
# UPLOAD_LOCATION=/mnt/nfs/immich-uploads
# DB_PASSWORD=CHANGE_ME_SECURE_PASSWORD
# DB_USERNAME=immich
# DB_DATABASE_NAME=immich
# REDIS_HOSTNAME=redis
# DB_HOSTNAME=database
# TZ=America/Los_Angeles
