{% comment %}
  Twisted Monk Suite - Urgency Banner Snippet
  
  Displays urgency messages to encourage purchases based on stock levels
  
  Usage:
    {% render 'urgency-banner', product: product %}
  
  Parameters:
    - product: Product object
    - style: (optional) 'inline' or 'floating', default 'inline'
{% endcomment %}

{% liquid
  assign current_variant = product.selected_or_first_available_variant
  assign inventory_quantity = current_variant.inventory_quantity
  assign available = current_variant.available
  
  assign critical_threshold = 10
  assign low_threshold = 50
  
  if style == nil
    assign style = 'inline'
  endif
  
  # Determine urgency level and message
  assign show_banner = false
  assign urgency_message = ''
  assign urgency_level = ''
  
  if available == false
    assign show_banner = true
    assign urgency_message = 'This item is currently out of stock'
    assign urgency_level = 'critical'
  elsif inventory_quantity <= critical_threshold
    assign show_banner = true
    assign urgency_message = 'Only ' | append: inventory_quantity | append: ' left in stock - Order soon!'
    assign urgency_level = 'critical'
  elsif inventory_quantity <= low_threshold
    assign show_banner = true
    assign urgency_message = 'Popular item - ' | append: inventory_quantity | append: ' available'
    assign urgency_level = 'warning'
  endif
%}

{% if show_banner %}
<div class="urgency-banner urgency-banner--{{ style }} urgency-banner--{{ urgency_level }}"
     data-product-id="{{ product.id }}"
     data-variant-id="{{ current_variant.id }}"
     data-urgency="{{ urgency_level }}"
     role="alert"
     aria-live="polite">
  
  <style>
    .urgency-banner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem 1.5rem;
      margin: 1rem 0;
      border-radius: 0.5rem;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    .urgency-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }
    
    .urgency-banner--inline {
      width: 100%;
    }
    
    .urgency-banner--floating {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 90%;
      width: auto;
    }
    
    .urgency-banner--warning {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #78350f;
      border: 2px solid #f59e0b;
    }
    
    .urgency-banner--critical {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #ffffff;
      border: 2px solid #dc2626;
      animation: slideIn 0.3s ease-out, pulse 2s ease-in-out infinite;
    }
    
    .urgency-banner__icon {
      display: inline-flex;
      margin-right: 0.75rem;
      font-size: 1.25rem;
    }
    
    .urgency-banner__message {
      flex: 1;
      text-align: center;
      font-size: 0.9375rem;
      letter-spacing: 0.025em;
    }
    
    .urgency-banner__close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0.25rem;
      margin-left: 1rem;
      opacity: 0.7;
      transition: opacity 0.2s;
      font-size: 1.5rem;
      line-height: 1;
    }
    
    .urgency-banner__close:hover {
      opacity: 1;
    }
    
    .urgency-banner__timer {
      display: inline-block;
      margin-left: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(1rem);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.02);
      }
    }
    
    @keyframes shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }
    
    @media (max-width: 768px) {
      .urgency-banner {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }
      
      .urgency-banner--floating {
        bottom: 1rem;
        max-width: 95%;
      }
      
      .urgency-banner__icon {
        font-size: 1rem;
        margin-right: 0.5rem;
      }
    }
    
    @media (prefers-reduced-motion: reduce) {
      .urgency-banner {
        animation: none;
      }
      .urgency-banner::before {
        animation: none;
      }
      .urgency-banner--critical {
        animation: none;
      }
    }
  </style>
  
  <span class="urgency-banner__icon" aria-hidden="true">
    {% if urgency_level == 'critical' %}
      ‚ö†Ô∏è
    {% else %}
      üî•
    {% endif %}
  </span>
  
  <span class="urgency-banner__message">
    {{ urgency_message }}
    {% if urgency_level == 'critical' and inventory_quantity > 0 %}
      <span class="urgency-banner__timer" data-countdown="15">
        <!-- Timer will be injected by JS -->
      </span>
    {% endif %}
  </span>
  
  {% if style == 'floating' %}
    <button class="urgency-banner__close" 
            type="button"
            aria-label="Close banner"
            onclick="this.parentElement.style.display='none'">
      √ó
    </button>
  {% endif %}
</div>

<script>
  (function() {
    const banner = document.querySelector('[data-urgency="{{ urgency_level }}"]');
    if (!banner) return;
    
    const timer = banner.querySelector('[data-countdown]');
    
    // Countdown timer for critical items
    if (timer) {
      const initialMinutes = parseInt(timer.dataset.countdown);
      let timeLeft = initialMinutes * 60; // Convert to seconds
      
      function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} to order`;
        
        if (timeLeft > 0) {
          timeLeft--;
          setTimeout(updateTimer, 1000);
        } else {
          // Timer expired - could trigger special action
          timer.textContent = 'Order now!';
          timer.style.animation = 'pulse 0.5s ease-in-out infinite';
        }
      }
      
      updateTimer();
    }
    
    // View counting for social proof
    const viewCount = sessionStorage.getItem(`product_views_${banner.dataset.productId}`) || 0;
    if (viewCount < 3) {
      sessionStorage.setItem(
        `product_views_${banner.dataset.productId}`,
        parseInt(viewCount) + 1
      );
    }
    
    // Add social proof message if item is popular
    if ('{{ urgency_level }}' === 'warning' && Math.random() > 0.5) {
      const messages = [
        '{{ inventory_quantity }} people are viewing this item',
        'Trending item - {{ inventory_quantity }} left',
        'High demand - {{ inventory_quantity }} available'
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      
      const messageElement = banner.querySelector('.urgency-banner__message');
      if (messageElement && Math.random() > 0.7) {
        // Occasionally show alternative message
        setTimeout(() => {
          messageElement.textContent = randomMessage;
        }, 3000);
      }
    }
    
    // Persist banner dismissal for floating style
    if ('{{ style }}' === 'floating') {
      const dismissedKey = `banner_dismissed_${banner.dataset.productId}_${banner.dataset.variantId}`;
      
      if (sessionStorage.getItem(dismissedKey)) {
        banner.style.display = 'none';
      }
      
      const closeBtn = banner.querySelector('.urgency-banner__close');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          sessionStorage.setItem(dismissedKey, 'true');
        });
      }
    }
    
    // Track banner impressions for analytics
    if (window.analytics) {
      window.analytics.track('Urgency Banner Viewed', {
        product_id: banner.dataset.productId,
        variant_id: banner.dataset.variantId,
        urgency_level: banner.dataset.urgency,
        style: '{{ style }}'
      });
    }
  })();
</script>
{% endif %}
