"""Advanced malware analysis lab simulator."""

import uuid

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import select

from app.dependencies import CurrentUser, DatabaseSession, raise_not_found
from app.models import AnalysisReport, MalwareSample
from app.schemas import AnalysisReportResponse, MalwareDetailResponse, MalwareSampleCreate, MalwareSampleResponse
from app.services.security_simulations import simulated_analysis


router = APIRouter(prefix="/malware", tags=["Malware Analysis"])


@router.post("/samples", response_model=MalwareSampleResponse, status_code=status.HTTP_201_CREATED)
async def create_sample(payload: MalwareSampleCreate, db: DatabaseSession, _: CurrentUser) -> MalwareSample:
    sample = MalwareSample(**payload.model_dump())
    db.add(sample)
    await db.flush()
    await db.refresh(sample)
    return sample


@router.get("/samples", response_model=list[MalwareSampleResponse])
async def list_samples(db: DatabaseSession) -> list[MalwareSample]:
    result = await db.execute(select(MalwareSample))
    return result.scalars().all()


@router.get("/samples/{sample_id}", response_model=MalwareDetailResponse)
async def get_sample(sample_id: str, db: DatabaseSession) -> MalwareDetailResponse:
    sample_uuid = uuid.UUID(str(sample_id))
    sample = await db.get(MalwareSample, sample_uuid)
    if not sample:
        raise_not_found("Sample")
    await db.refresh(sample, attribute_names=["report"])
    return MalwareDetailResponse(sample=sample, report=sample.report)


@router.post("/samples/{sample_id}/analyze", response_model=MalwareDetailResponse)
async def analyze_sample(sample_id: str, db: DatabaseSession, _: CurrentUser) -> MalwareDetailResponse:
    sample_uuid = uuid.UUID(str(sample_id))
    sample = await db.get(MalwareSample, sample_uuid)
    if not sample:
        raise_not_found("Sample")
    report = simulated_analysis(sample)
    report.sample_id = sample.id
    sample.status = "analyzed"
    db.add(report)
    await db.flush()
    await db.refresh(sample, attribute_names=["report"])
    return MalwareDetailResponse(sample=sample, report=sample.report)


@router.get("/yara", response_model=list[AnalysisReportResponse])
async def list_yara_rules(db: DatabaseSession) -> list[AnalysisReport]:
    result = await db.execute(select(AnalysisReport))
    return result.scalars().all()
